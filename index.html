<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="äººç”Ÿè„šæœ¬">
  <meta name="theme-color" content="#667eea">
  <title>äººç”Ÿè„šæœ¬ - Life Script</title>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
    
    :root {
      --bg: #FDFCF8;
      --text: #2C2C2C;
      --sub: #8B8B8B;
      --border: #E5E3DC;
      --primary: #667eea;
      --health: #A8D5BA;
      --family: #FFD4A3;
      --work: #A5C9E0;
      --growth: #E0B3D9;
      --custom: #D4D4D4;
      --done: #95D7AE;
      --undone: #F4A7A7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Noto Sans SC', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* ========== ç™»å½•/æ³¨å†Œé¡µé¢ ========== */
    #auth-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #auth-layer.hide {
      display: none;
    }

    .auth-container {
      background: white;
      border-radius: 24px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .auth-title {
      font-family: 'Noto Serif SC', serif;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: var(--text);
    }

    .auth-subtitle {
      font-size: 14px;
      color: var(--sub);
      text-align: center;
      margin-bottom: 30px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .auth-input {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .auth-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .auth-btn-primary {
      background: var(--primary);
      color: white;
    }

    .auth-btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .auth-btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .auth-btn-secondary {
      background: white;
      color: var(--text);
      border: 2px solid var(--border);
    }

    .auth-btn-secondary:hover {
      background: #f9f9f9;
      border-color: var(--text);
    }

    .auth-toggle {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--sub);
    }

    .auth-toggle a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-toggle a:hover {
      text-decoration: underline;
    }

    .auth-error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
      display: none;
    }

    .auth-error.show {
      display: block;
    }

    .auth-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .auth-loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 10001;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-text {
      font-size: 16px;
      color: var(--text);
    }

    /* ========== ç”¨æˆ·ä¿¡æ¯æ  ========== */
    .user-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .user-email {
      font-size: 14px;
      color: var(--sub);
      font-weight: 500;
    }

    .logout-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #f9f9f9;
      border-color: var(--text);
    }

    /* ========== åŸæœ‰æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ ========== */
    #intro-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.8s ease;
    }

    #intro-layer.hide {
      opacity: 0;
      pointer-events: none;
    }

    .intro-container {
      width: 100%;
      max-width: 500px;
      height: 100vh;
      position: relative;
      text-align: center;
      padding: 80px 30px;
      overflow: hidden;
    }

    .intro-slide {
      animation: fadeIn 0.5s;
    }

    .intro-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ddd;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0 4px;
    }

    .intro-dot.active {
      width: 24px;
      border-radius: 4px;
      background: #667eea;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .start-btn {
      padding: 14px 40px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 30px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 15px;
      letter-spacing: 3px;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .start-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    .header {
      position: sticky;
      top: 0;
      padding: 20px;
      background: rgba(253, 252, 248, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .user-name {
      font-family: 'Noto Serif SC', serif;
      font-size: 18px;
      font-weight: 600;
    }

    .user-name input {
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      color: var(--text);
      width: 150px;
      border-bottom: 1px dashed var(--border);
    }

    .user-name input:focus {
      outline: none;
      border-bottom-color: var(--text);
    }

    .motto {
      font-family: 'Noto Serif SC', serif;
      font-size: 13px;
      color: var(--sub);
      font-style: italic;
      margin-top: 8px;
    }

    .week-info {
      display: flex;
      gap: 10px;
      font-size: 11px;
      color: var(--sub);
      flex-wrap: wrap;
    }

    .week-info span {
      padding: 4px 10px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .page-container {
      min-height: calc(100vh - 200px);
      padding: 20px;
      padding-bottom: 100px;
    }

    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-title {
      font-family: 'Noto Serif SC', serif;
      font-size: 20px;
      font-weight: 600;
      margin: 30px 0 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-fill {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .category-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .category-btn {
      padding: 12px 8px;
      border: 2px solid transparent;
      border-radius: 12px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .category-btn.active {
      border-color: var(--text);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .tag-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .tag-btn {
      padding: 8px 14px;
      background: #f5f5f5;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-btn.active {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }

    .tag-btn:hover {
      transform: translateY(-1px);
    }

    .batch-hint {
      font-size: 12px;
      color: var(--sub);
      text-align: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .week-table-wrapper {
      overflow-x: auto;
      margin: 20px 0;
      border-radius: 16px;
      background: white;
      padding: 15px;
      border: 1px solid var(--border);
    }

    .week-table {
      display: grid;
      grid-template-columns: 50px repeat(7, 1fr);
      gap: 4px;
      min-width: 100%;
    }

    .week-header {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      padding: 10px 5px;
      background: #f8f8f8;
      border-radius: 8px;
    }

    .week-header.today {
      background: var(--text);
      color: white;
    }

    .time-label {
      font-size: 10px;
      color: var(--sub);
      text-align: center;
      padding: 8px 0;
      font-family: monospace;
    }

    .time-cell {
      min-height: 35px;
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .time-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .time-cell.filled {
      font-weight: 500;
      border: none;
    }

    .time-cell.today-col {
      border: 2px solid var(--text);
    }

    .checkin-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .time-block {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .time-block:last-child {
      border-bottom: none;
    }

    .time-block-time {
      font-family: monospace;
      font-size: 14px;
      font-weight: 600;
      min-width: 60px;
      color: var(--sub);
    }

    .time-block-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-block-tag {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      flex: 1;
    }

    .time-block-tag.empty {
      background: #f5f5f5;
      color: var(--sub);
    }

    .check-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .check-btn.done {
      background: var(--done);
      border-color: var(--done);
    }

    .check-btn.undone {
      background: var(--undone);
      border-color: var(--undone);
    }

    .check-btn:hover {
      transform: scale(1.1);
    }

    .review-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .review-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .review-input {
      width: 100%;
      border: 1px solid var(--border);
      background: #fafafa;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }

    .review-input:focus {
      outline: none;
      border-color: var(--text);
      background: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--sub);
    }

    .category-breakdown {
      margin-top: 20px;
    }

    .category-bar {
      margin-bottom: 15px;
    }

    .category-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .category-bar-track {
      height: 24px;
      background: #f5f5f5;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .category-bar-fill {
      height: 100%;
      transition: width 0.6s ease;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      color: white;
      font-weight: 600;
    }

    .ai-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      margin-bottom: 20px;
    }

    .ai-btn {
      width: 100%;
      padding: 15px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .ai-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .ai-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .ai-result {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.8;
      backdrop-filter: blur(10px);
      display: none;
      white-space: pre-line;
    }

    .ai-result.show {
      display: block;
      animation: slideDown 0.4s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tool-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .tool-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .category-config {
      margin-bottom: 20px;
    }

    .category-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #fafafa;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .color-picker {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid var(--border);
      cursor: pointer;
    }

    .category-name-input {
      flex: 1;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-item {
      padding: 6px 12px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tag-remove {
      cursor: pointer;
      color: var(--sub);
      font-weight: 600;
    }

    .tag-remove:hover {
      color: var(--text);
    }

    .add-tag-input {
      padding: 6px 12px;
      border: 1px dashed var(--border);
      border-radius: 16px;
      font-size: 12px;
      width: 120px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--text);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #f5f5f5;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 10px;
    }

    .nav-icon {
      font-size: 24px;
      margin-bottom: 4px;
      display: block;
    }

    .nav-label {
      font-size: 11px;
      color: var(--sub);
    }

    .nav-item.active .nav-label {
      color: var(--text);
      font-weight: 600;
    }

    .nav-item:hover {
      transform: translateY(-2px);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal {
      background: white;
      border-radius: 20px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .modal-field {
      margin-bottom: 15px;
    }

    .modal-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .modal-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .category-selector {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .hint {
      font-size: 12px;
      color: var(--sub);
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 3px solid var(--text);
    }

    .date-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .date-btn {
      min-width: 80px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
    }

    .date-btn.active {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }

    .date-btn-day {
      font-size: 11px;
      color: var(--sub);
      margin-bottom: 3px;
    }

    .date-btn.active .date-btn-day {
      color: rgba(255,255,255,0.8);
    }

    .date-btn-date {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- ç™»å½•/æ³¨å†Œå±‚ -->
  <div id="auth-layer">
    <div id="authLoading" class="loading-overlay">
      <div class="auth-loading-spinner"></div>
      <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <div class="auth-container" id="authContainer">
      <div class="auth-title">ğŸ¬ äººç”Ÿè„šæœ¬</div>
      <div class="auth-subtitle">æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´» Â· ä½ æ˜¯äººç”Ÿçš„å¯¼æ¼”</div>
      
      <div class="auth-error" id="authError"></div>
      
      <form class="auth-form" id="authForm">
        <input 
          type="email" 
          class="auth-input" 
          id="authEmail" 
          placeholder="é‚®ç®±åœ°å€" 
          required
        >
        <input 
          type="password" 
          class="auth-input" 
          id="authPassword" 
          placeholder="å¯†ç " 
          required
        >
        <button type="submit" class="auth-btn auth-btn-primary" id="authSubmitBtn">
          ç™»å½•
        </button>
      </form>
      
      <div class="auth-toggle">
        <span id="authToggleText">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
        <a id="authToggleBtn">ç«‹å³æ³¨å†Œ</a>
      </div>
      
      <div class="auth-toggle" style="margin-top: 10px;">
        <a onclick="handleForgotPassword()">å¿˜è®°å¯†ç ï¼Ÿ</a>
      </div>
    </div>
  </div>

  <!-- å¼•å¯¼å±‚ -->
  <div id="intro-layer" style="display:none;">
    <div class="intro-container" id="introContainer">
      <div class="intro-slide" data-slide="0">
        <div style="font-size:80px; margin-bottom:30px;">ğŸ¬</div>
        <h2 style="font-size:32px; font-weight:700; margin-bottom:15px; font-family: 'Noto Serif SC', serif;">äººç”Ÿè„šæœ¬</h2>
        <p style="font-size:16px; color:#666; margin-bottom:40px;">æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»<br>ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼”</p>
        <div style="font-size:18px; font-weight:600; margin-bottom:20px; color:#667eea;">è¿™é‡Œæˆ‘ä»¬å°†æ—¶é—´åˆ†æˆå››ç±»</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; max-width:300px; margin:0 auto;">
          <div style="background:#A8D5BA; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ’ª</div>
            <div style="font-size:14px;">å¥åº·ä¹ æƒ¯</div>
          </div>
          <div style="background:#FFD4A3; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ </div>
            <div style="font-size:14px;">å®¶åº­æ—¶é—´</div>
          </div>
          <div style="background:#A5C9E0; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ’¼</div>
            <div style="font-size:14px;">å·¥ä½œæ—¶é—´</div>
          </div>
          <div style="background:#E0B3D9; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ“š</div>
            <div style="font-size:14px;">è‡ªæˆ‘æˆé•¿</div>
          </div>
        </div>
      </div>

      <div class="intro-slide" data-slide="1" style="display:none;">
        <div style="font-size:80px; margin-bottom:30px;">ğŸ­</div>
        <h2 style="font-size:28px; font-weight:700; margin-bottom:20px;">æ¼”å‘˜+å¯¼æ¼”çš„åŒé‡è§†è§’</h2>
        <div style="text-align:left; max-width:320px; margin:0 auto; font-size:15px; line-height:1.9; color:#555;">
          <p style="margin-bottom:20px;"><strong style="color:#667eea; font-size:16px;">80%å›ºå®š,20%çµæ´»</strong></p>
          <p>Â· å›ºå®š80%çš„æ—¥å¸¸åŠ¨ä½œ,å»ºç«‹ç§©åºæ„Ÿ</p>
          <p>Â· ä¸ºé•¿æœŸç›®æ ‡ç•™å‡ºæ—¶é—´</p>
          <p>Â· åŸ¹å…»ç»ˆèº«ä¹ æƒ¯</p>
          <p>Â· æå‡åº”å¯¹æ··ä¹±çš„èƒ½åŠ›</p>
        </div>
        <div style="margin-top:30px; padding:15px; background:#E8F5E9; border-radius:12px; font-size:13px; color:#4CAF50; text-align:left; max-width:320px; margin:30px auto 0;">
          <div style="font-weight:600; margin-bottom:8px;">ğŸ’¡ çŸ¥è¡Œåˆä¸€ç‡å°è´´å£«</div>
          <div style="font-size:12px; line-height:1.6;">
            Â· ç†æƒ³åŒºé—´æ˜¯ 75-85%,ä¸æ˜¯100%<br>
            Â· é€‚åº¦çš„æœªå®Œæˆè¯´æ˜ä½ åœ¨æŒ‘æˆ˜è‡ªå·±<br>
            Â· è¿‡é«˜å¯èƒ½è®¡åˆ’å¤ªä¿å®ˆ,è¿‡ä½éœ€è¦è°ƒæ•´
          </div>
        </div>
        <div style="margin-top:15px; padding:20px; background:#f5f5f5; border-radius:12px; font-size:14px; color:#999;">
          å‘¨è®¡åˆ’ â†’ æ—¥æ‰“å¡ â†’ å‘¨å¤ç›˜
        </div>
      </div>

      <div class="intro-slide" data-slide="2" style="display:none;">
        <div style="font-size:80px; margin-bottom:30px;">ğŸ“</div>
        <h2 style="font-size:28px; font-weight:700; margin-bottom:30px;">ä¸‰æ­¥å¼€å§‹ä½ çš„äººç”Ÿå‰§æœ¬</h2>
        <div style="text-align:left; max-width:320px; margin:0 auto;">
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div style="width:40px; height:40px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; flex-shrink:0;">1</div>
            <div>
              <div style="font-weight:600; margin-bottom:5px;">å‘¨ä¸€åˆ¶å®šå‰§æœ¬</div>
              <div style="font-size:13px; color:#666;">åœ¨"å‘¨è®¡åˆ’"é¡µæ’ç­,å›ºå®š80%çš„æ—¶é—´</div>
            </div>
          </div>
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div style="width:40px; height:40px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; flex-shrink:0;">2</div>
            <div>
              <div style="font-weight:600; margin-bottom:5px;">æ¯å¤©æ‰§è¡Œæ‰“å¡</div>
              <div style="font-size:13px; color:#666;">åœ¨"ä»Šæ—¥æ‰“å¡"é¡µè®°å½•,å®Œæˆâœ“,æœªå®Œæˆâœ—</div>
            </div>
          </div>
          <div style="display:flex; gap:15px;">
            <div style="width:40px; height:40px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; flex-shrink:0;">3</div>
            <div>
              <div style="font-weight:600; margin-bottom:5px;">å‘¨æ—¥å¯¼æ¼”å¤ç›˜</div>
              <div style="font-size:13px; color:#666;">åœ¨"å‘¨å¤ç›˜"é¡µåˆ†æ,çŸ¥è¡Œåˆä¸€ç‡+AIæ´å¯Ÿ</div>
            </div>
          </div>
        </div>
      </div>

      <div class="intro-slide" data-slide="3" style="display:none;">
        <div style="font-size:80px; margin-bottom:30px;">ğŸš€</div>
        <h2 style="font-size:28px; font-weight:700; margin-bottom:20px;">å‡†å¤‡å¥½äº†å—?</h2>
        <p style="font-size:16px; color:#666; margin-bottom:40px;">è®©æˆ‘ä»¬å¼€å¯ä½ çš„äººç”Ÿå‰§æœ¬ä¹‹æ—…<br>ä»è¾“å…¥ä½ çš„åå­—å¼€å§‹</p>
        <button class="start-btn" onclick="startApp()">è¿›å…¥ç‰‡åœº</button>
      </div>

      <div style="position:absolute; bottom:100px; left:0; right:0; display:flex; justify-content:center; align-items:center; gap:10px;">
        <span class="intro-dot active" data-index="0" onclick="goToSlide(0)></span>
        <span class="intro-dot" data-index="1" onclick="goToSlide(1)"></span>
        <span class="intro-dot" data-index="2" onclick="goToSlide(2)"></span>
        <span class="intro-dot" data-index="3" onclick="goToSlide(3)"></span>
      </div>

      <button onclick="nextSlide()" style="position:absolute; bottom:30px; right:30px; background:#667eea; color:white; border:none; padding:12px 30px; border-radius:25px; font-size:14px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(102,126,234,0.3);" id="nextBtn">ä¸‹ä¸€é¡µ</button>
      <button onclick="startApp()" style="position:absolute; top:30px; right:30px; background:transparent; color:#999; border:none; padding:8px 16px; font-size:14px; cursor:pointer;">è·³è¿‡</button>
    </div>
  </div>

  <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
  <div class="user-bar" style="display:none;" id="userBar">
    <div class="user-email" id="userEmail"></div>
    <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
  </div>

  <!-- é¡¶éƒ¨ä¿¡æ¯ -->
  <div class="header" style="display:none;" id="mainHeader">
    <div class="user-info">
      <div class="user-name">
        äººç”Ÿè„šæœ¬ - <span id="userNameDisplay" onclick="editUserName()" style="cursor:pointer; border-bottom:1px dashed transparent;">å¯¼æ¼”</span>
      </div>
    </div>
    <div class="motto">æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»ã€‚ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼”ã€‚</div>
    <div class="week-info">
      <span id="yearInfo">2025å¹´</span>
      <span id="weekNum">ç¬¬6å‘¨</span>
      <span id="dateRange">2æœˆ3æ—¥ - 2æœˆ9æ—¥</span>
    </div>
  </div>

  <!-- é¡µé¢å®¹å™¨ -->
  <div class="page-container" style="display:none;" id="pageContainer">
    <!-- åŸæœ‰é¡µé¢å†…å®¹ä¿æŒä¸å˜... -->
    <div id="page-plan" class="page active">
      <div class="section-title">ğŸ“‹ æœ¬å‘¨å‰§æœ¬</div>
      <div class="quick-fill">
        <div style="font-weight: 600; margin-bottom: 15px;">âš¡ å¿«æ·æ’ç­</div>
        <div class="category-selector" id="categorySelector"></div>
        <div class="tag-selector" id="tagSelector"></div>
        <div class="batch-hint">ğŸ’¡ é€‰æ‹©ç±»åˆ«å’Œæ ‡ç­¾å,ç‚¹å‡»ä¸‹æ–¹æ ¼å­å³å¯å¿«é€Ÿå¡«å……</div>
      </div>
      <div class="week-table-wrapper">
        <div class="week-table" id="weekTable"></div>
      </div>
    </div>

    <div id="page-checkin" class="page">
      <div class="section-title">âœ… ä»Šæ—¥æ‰“å¡</div>
      <div class="date-selector" id="dateSelector"></div>
      <div class="hint">ğŸ’¡ ç‚¹å‡» âœ“ è¡¨ç¤ºå®Œæˆ,âœ— è¡¨ç¤ºæœªå®Œæˆ(éœ€è¯´æ˜åŸå› )</div>
      <div class="checkin-card" id="checkinList"></div>
    </div>

    <div id="page-review" class="page">
      <div style="display:flex; gap:10px; margin-bottom:20px; background:white; padding:10px; border-radius:12px;">
        <button class="btn btn-secondary" id="viewWeekBtn" onclick="switchReviewView('week')" style="flex:1">æœ¬å‘¨</button>
        <button class="btn btn-secondary" id="viewMonthBtn" onclick="switchReviewView('month')" style="flex:1">æœ¬æœˆ</button>
      </div>

      <div id="weekView">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div class="section-title" style="margin:0;">ğŸ“Š å‘¨åº¦å®¡è§†</div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statCompletion">0%</div>
            <div class="stat-label">çŸ¥è¡Œåˆä¸€ç‡</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0/119</div>
            <div class="stat-label">å®Œæˆæ—¶æ®µ</div>
          </div>
        </div>

        <div class="review-section">
          <div class="review-label">â° æ—¶é—´åˆ†å¸ƒ</div>
          <div class="category-breakdown" id="categoryBreakdown"></div>
        </div>

        <div class="review-section">
          <div class="review-label">ğŸŒŸ é«˜å…‰æ—¶åˆ» (Highlight)</div>
          <textarea class="review-input" id="reviewHighlight" placeholder="æœ¬å‘¨æœ€æ»¡æ„çš„è¡¨ç°..."></textarea>
        </div>

        <div class="review-section">
          <div class="review-label">ğŸ’£ ç©¿å¸®é•œå¤´ (NG)</div>
          <textarea class="review-input" id="reviewNG" placeholder="é—æ†¾æˆ–æœªå®Œæˆçš„äº‹..."></textarea>
        </div>

        <div class="review-section">
          <div class="review-label">ğŸ’¡ å¯¼æ¼”æ€è€ƒ (Thinking)</div>
          <textarea class="review-input" id="reviewThinking" placeholder="ä¸‹å‘¨å‰§æœ¬ä¼˜åŒ–æ–¹æ¡ˆ..."></textarea>
        </div>
      </div>

      <div id="monthView" style="display:none;">
        <div class="section-title">ğŸ“… æœˆåº¦æ€»è§ˆ</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="monthCompletion">0%</div>
            <div class="stat-label">æœˆåº¦çŸ¥è¡Œåˆä¸€ç‡</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="monthTotal">0/0</div>
            <div class="stat-label">å®Œæˆ/è®¡åˆ’</div>
          </div>
        </div>
      </div>
    </div>

    <div id="page-tools" class="page">
      <div class="section-title">âš™ï¸ è®¾ç½®</div>
      <div class="tool-section">
        <div class="tool-title">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        <div class="hint">âœ¨ æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯ï¼Œæ— éœ€æ‰‹åŠ¨å¤‡ä»½</div>
      </div>

      <div class="tool-section">
        <div class="tool-title">ğŸ”Œ AI é…ç½®</div>
        <div class="modal-field">
          <label class="modal-label">é€‰æ‹©AIå¹³å°</label>
          <select class="modal-select" id="apiProvider" onchange="updateAPIProvider()">
            <option value="deepseek">DeepSeek</option>
            <option value="zhipu">æ™ºè°±æ¸…è¨€ (GLM-4)</option>
          </select>
        </div>
        <div class="modal-field">
          <label class="modal-label" id="apiKeyLabel">DeepSeek API Key</label>
          <input type="text" class="modal-input" id="apiKey" placeholder="sk-...">
        </div>
        <button class="btn btn-primary" onclick="saveAPIKey()">ä¿å­˜é…ç½®</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <div class="nav-bar" style="display:none;" id="navBar">
    <div class="nav-item active" onclick="switchPage('plan')">
      <span class="nav-icon">ğŸ“‹</span>
      <div class="nav-label">å‰§æœ¬å®‰æ’</div>
    </div>
    <div class="nav-item" onclick="switchPage('checkin')">
      <span class="nav-icon">âœ…</span>
      <div class="nav-label">ä»Šæ—¥æ‰“å¡</div>
    </div>
    <div class="nav-item" onclick="switchPage('review')">
      <span class="nav-icon">ğŸ“Š</span>
      <div class="nav-label">å¯¼æ¼”æ€»ç»“</div>
    </div>
    <div class="nav-item" onclick="switchPage('tools')">
      <span class="nav-icon">âš™ï¸</span>
      <div class="nav-label">å·¥å…·</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ========== å…¨å±€é”™è¯¯å¤„ç† ==========
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('JavaScript Error:', message);
      console.error('Source:', source);
      console.error('Line:', lineno);
      console.error('Column:', colno);
      console.error('Error object:', error);
      
      // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position:fixed; top:10px; left:10px; right:10px; background:#fee; color:#c33; padding:15px; border-radius:8px; font-size:14px; z-index:99999;';
      errorDiv.innerHTML = `<strong>é”™è¯¯ï¼š</strong>${message}<br><small>è¡Œï¼š${lineno}ï¼Œåˆ—ï¼š${colno}</small>`;
      document.body.appendChild(errorDiv);
    };

    // ========== Supabase é…ç½® ==========
    const SUPABASE_URL = 'https://eqetphivynokwhsfzzqs.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_wbuHZKTMjP1DI0g8B43TQA_dqZzRCml';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========== è®¤è¯çŠ¶æ€ ==========
    let currentUser = null;
    let isLoginMode = true; // true=ç™»å½•, false=æ³¨å†Œ

    // ========== æ•°æ®æ¨¡å‹ ==========
    const DEFAULT_CATEGORIES = {
      health: {
        name: 'å¥åº·ä¹ æƒ¯',
        color: '#A8D5BA',
        tags: ['å†¥æƒ³', 'è¿åŠ¨', 'ç‘œä¼½', 'ç¡çœ ', 'è¥å…»é¤']
      },
      family: {
        name: 'å®¶åº­æ—¶é—´',
        color: '#FFD4A3',
        tags: ['é™ªå­©å­', 'é™ªçˆ¶æ¯', 'å®¶åŠ¡', 'äº²å­æ´»åŠ¨']
      },
      work: {
        name: 'å·¥ä½œæ—¶é—´',
        color: '#A5C9E0',
        tags: ['åŠ ç­ç‹—', 'ä¼šè®®', 'é¡¹ç›®', 'å­¦ä¹ ']
      },
      growth: {
        name: 'è‡ªæˆ‘æˆé•¿',
        color: '#E0B3D9',
        tags: ['å†™ä½œ', 'é˜…è¯»', 'æ€è€ƒ', 'å­¦ä¹ ']
      },
      custom: {
        name: 'ä¼‘é—²å¨±ä¹',
        color: '#D4D4D4',
        tags: ['è¿½å‰§', 'æ¸¸æˆ', 'ç¤¾äº¤', 'è´­ç‰©']
      }
    };

    let appState = {
      userName: 'å¯¼æ¼”',
      categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
      weekPlan: {},
      weekCheckin: {},
      reviewNotes: {
        highlight: '',
        ng: '',
        thinking: ''
      },
      apiKey: '',
      apiProvider: 'deepseek',
      currentDay: 6,
      currentEditCell: null,
      selectedCategory: 'health',
      selectedTag: null,
      currentCheckinDay: 6,
      currentWeekKey: ''
    };

    // ========== è®¤è¯å‡½æ•° ==========
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session) {
        currentUser = session.user;
        showApp();
      } else {
        showAuth();
      }
    }

    function showAuth() {
      document.getElementById('auth-layer').classList.remove('hide');
      document.getElementById('userBar').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'none';
      document.getElementById('pageContainer').style.display = 'none';
      document.getElementById('navBar').style.display = 'none';
    }

    function showApp() {
      document.getElementById('auth-layer').classList.add('hide');
      document.getElementById('userBar').style.display = 'flex';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('pageContainer').style.display = 'block';
      document.getElementById('navBar').style.display = 'flex';
      document.getElementById('userEmail').textContent = currentUser.email;
      
      // æ£€æŸ¥é¦–æ¬¡ä½¿ç”¨
      checkFirstUse();
      
      // åŠ è½½æ•°æ®
      loadUserData();
      updateWeekInfo();
      renderCategorySelector();
      renderWeekTable();
      renderDateSelector();
      renderCheckinList();
      
      document.getElementById('userNameDisplay').textContent = appState.userName;
    }

    async function handleAuthSubmit(e) {
      e.preventDefault();
      
      console.log('âœ… handleAuthSubmit è¢«è°ƒç”¨äº†');
      
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const submitBtn = document.getElementById('authSubmitBtn');
      
      console.log('ğŸ“§ é‚®ç®±:', email);
      console.log('ğŸ”‘ å¯†ç :', password ? 'å·²è¾“å…¥' : 'æœªè¾“å…¥');
      console.log('ğŸ“ æ¨¡å¼:', isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'å¤„ç†ä¸­...';
      hideAuthError();

      try {
        if (isLoginMode) {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
          });
          
          if (error) throw error;
          
          currentUser = data.user;
          showApp();
        } else {
          const { data, error } = await supabase.auth.signUp({
            email,
            password
          });
          
          if (error) throw error;
          
          // è‡ªåŠ¨ç™»å½•
          currentUser = data.user;
          showApp();
        }
      } catch (error) {
        showAuthError(error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ';
      }
    }

    function toggleAuthMode() {
      isLoginMode = !isLoginMode;
      
      const title = document.querySelector('.auth-title');
      const toggleText = document.getElementById('authToggleText');
      const toggleBtn = document.getElementById('authToggleBtn');
      const submitBtn = document.getElementById('authSubmitBtn');
      
      if (isLoginMode) {
        toggleText.textContent = 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ';
        toggleBtn.textContent = 'ç«‹å³æ³¨å†Œ';
        submitBtn.textContent = 'ç™»å½•';
      } else {
        toggleText.textContent = 'å·²æœ‰è´¦å·ï¼Ÿ';
        toggleBtn.textContent = 'ç«‹å³ç™»å½•';
        submitBtn.textContent = 'æ³¨å†Œ';
      }
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      currentUser = null;
      showAuth();
    }

    async function handleForgotPassword() {
      const email = prompt('è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼Œæˆ‘ä»¬å°†å‘é€é‡ç½®å¯†ç é“¾æ¥ï¼š');
      if (!email) return;
      
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email);
        
        if (error) throw error;
        
        alert('å¯†ç é‡ç½®é“¾æ¥å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶ï¼');
      } catch (error) {
        alert('å‘é€å¤±è´¥ï¼š' + error.message);
      }
    }

    function showAuthError(message) {
      const errorEl = document.getElementById('authError');
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    function hideAuthError() {
      const errorEl = document.getElementById('authError');
      errorEl.textContent = '';
      errorEl.classList.remove('show');
    }

    // ========== æ•°æ®åŠ è½½å’Œä¿å­˜ ==========
    async function loadUserData() {
      if (!currentUser) return;

      // å¹¶è¡ŒåŠ è½½ç”¨æˆ·è®¾ç½®å’Œæœ¬å‘¨æ•°æ®
      const [settingsData, planData] = await Promise.all([
        supabase
          .from('user_settings')
          .select('*')
          .eq('user_id', currentUser.id)
          .single(),
        supabase
          .from('weekly_plans')
          .select('*')
          .eq('user_id', currentUser.id)
          .eq('week_key', appState.currentWeekKey)
          .single()
      ]);

      // åŠ è½½ç”¨æˆ·è®¾ç½®
      if (settingsData.data) {
        appState.userName = settingsData.data.user_name || 'å¯¼æ¼”';
        appState.categories = settingsData.data.categories || appState.categories;
        appState.apiKey = settingsData.data.api_key || '';
        appState.apiProvider = settingsData.data.api_provider || 'deepseek';
      }

      // åŠ è½½æœ¬å‘¨è®¡åˆ’
      if (planData.data && planData.data.plan) {
        appState.weekPlan = planData.data.plan;
      }

      // åŠ è½½æ‰“å¡è®°å½•
      const { data: checkinData } = await supabase
        .from('daily_checkins')
        .select('*')
        .eq('user_id', currentUser.id);
      
      if (checkinData) {
        appState.weekCheckin = {};
        checkinData.forEach(record => {
          if (!appState.weekCheckin[record.day]) {
            appState.weekCheckin[record.day] = {};
          }
          
          if (record.status === 'done') {
            appState.weekCheckin[record.day][record.hour] = 'done';
          } else if (record.status === 'undone') {
            appState.weekCheckin[record.day][record.hour] = {
              status: 'undone',
              reason: record.reason
            };
          }
        });
      }

      // åŠ è½½å¤ç›˜ç¬”è®°
      const { data: notesData } = await supabase
        .from('review_notes')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('week_key', appState.currentWeekKey)
        .single();
      
      if (notesData && notesData.data) {
        appState.reviewNotes = {
          highlight: notesData.data.highlight || '',
          ng: notesData.data.ng || '',
          thinking: notesData.data.thinking || ''
        };
      }
    }

    async function saveUserData() {
      if (!currentUser) return;

      // ä¿å­˜ç”¨æˆ·è®¾ç½®
      await supabase
        .from('user_settings')
        .upsert({
          user_id: currentUser.id,
          user_name: appState.userName,
          categories: appState.categories,
          api_key: appState.apiKey,
          api_provider: appState.apiProvider
        }, {
          onConflict: 'user_id'
        });

      // ä¿å­˜æœ¬å‘¨è®¡åˆ’
      await supabase
        .from('weekly_plans')
        .upsert({
          user_id: currentUser.id,
          week_key: appState.currentWeekKey,
          plan: appState.weekPlan
        }, {
          onConflict: 'user_id,week_key'
        });

      // ä¿å­˜å¤ç›˜ç¬”è®°
      await supabase
        .from('review_notes')
        .upsert({
          user_id: currentUser.id,
          week_key: appState.currentWeekKey,
          highlight: appState.reviewNotes.highlight || '',
          ng: appState.reviewNotes.ng || '',
          thinking: appState.reviewNotes.thinking || ''
        }, {
          onConflict: 'user_id,week_key'
        });
    }

    async function saveCheckinData(day, hour, data) {
      if (!currentUser) return;

      const checkinData = {
        user_id: currentUser.id,
        day,
        hour,
        status: data.status,
        reason: data.reason || null
      };

      await supabase
        .from('daily_checkins')
        .upsert(checkinData, {
          onConflict: 'user_id,day,hour'
        });
    }

    // ========== è¾…åŠ©å‡½æ•°ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰==========
    function getRatingInfo(rate) {
      if (rate >= 85) {
        return { level: 'å“è¶Š', icon: 'ğŸŒŸ', color: '#FFD700', inIdealRange: false };
      } else if (rate >= 75) {
        return { level: 'ä¼˜ç§€', icon: 'ğŸ†', color: '#4CAF50', inIdealRange: true };
      } else if (rate >= 65) {
        return { level: 'è‰¯å¥½', icon: 'ğŸ‘', color: '#2196F3', inIdealRange: false };
      } else if (rate >= 55) {
        return { level: 'åŠæ ¼', icon: 'âš ï¸', color: '#FF9800', inIdealRange: false };
      } else {
        return { level: 'éœ€æ”¹è¿›', icon: 'ğŸ”´', color: '#F44336', inIdealRange: false };
      }
    }

    function updateWeekInfo() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const beijingTime = new Date(utc + (3600000 * 8));
      
      const year = beijingTime.getFullYear();
      const weekNum = getWeekNumber(beijingTime);
      
      appState.currentWeekKey = `${year}-W${String(weekNum).padStart(2, '0')}`;
      
      const dayOfWeek = beijingTime.getDay();
      appState.currentDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      appState.currentCheckinDay = appState.currentDay;
      
      const monday = new Date(beijingTime);
      monday.setDate(beijingTime.getDate() - appState.currentDay);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      document.getElementById('yearInfo').textContent = `${year}å¹´`;
      document.getElementById('weekNum').textContent = `ç¬¬${weekNum}å‘¨`;
      document.getElementById('dateRange').textContent = 
        `${monday.getMonth() + 1}æœˆ${monday.getDate()}æ—¥ - ${sunday.getMonth() + 1}æœˆ${sunday.getDate()}æ—¥`;
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // ç®€åŒ–ç‰ˆæ¸²æŸ“å‡½æ•°
    function renderCategorySelector() {
      const container = document.getElementById('categorySelector');
      container.innerHTML = '';
      
      Object.keys(appState.categories).forEach(key => {
        const cat = appState.categories[key];
        const btn = document.createElement('div');
        btn.className = 'category-btn';
        if (appState.selectedCategory === key) btn.classList.add('active');
        btn.style.background = cat.color;
        btn.textContent = cat.name;
        btn.onclick = () => {
          appState.selectedCategory = key;
          appState.selectedTag = null;
          renderCategorySelector();
        };
        container.appendChild(btn);
      });
    }

    function renderWeekTable() {
      const container = document.getElementById('weekTable');
      container.innerHTML = '';

      const headers = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
      headers.forEach((h, i) => {
        const cell = document.createElement('div');
        cell.className = 'week-header';
        if (i > 0 && i - 1 === appState.currentDay) cell.classList.add('today');
        cell.textContent = h;
        container.appendChild(cell);
      });

      for (let hour = 7; hour <= 23; hour++) {
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-label';
        timeLabel.textContent = `${hour}:00`;
        container.appendChild(timeLabel);

        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = 'time-cell';
          if (day === appState.currentDay) cell.classList.add('today-col');

          const task = appState.weekPlan[day]?.[hour];
          if (task) {
            const cat = appState.categories[task.category];
            cell.style.background = cat.color;
            cell.textContent = task.tag;
            cell.classList.add('filled');
          }

          cell.onclick = () => {
            if (appState.selectedTag && appState.selectedCategory) {
              if (!appState.weekPlan[day]) appState.weekPlan[day] = {};
              appState.weekPlan[day][hour] = {
                category: appState.selectedCategory,
                tag: appState.selectedTag
              };
              saveUserData();
              renderWeekTable();
            }
          };
          container.appendChild(cell);
        }
      }
    }

    function renderDateSelector() {
      const container = document.getElementById('dateSelector');
      container.innerHTML = '';

      const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
      const now = new Date();
      const dayOfWeek = now.getDay();
      const monday = new Date(now);
      monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

      days.forEach((name, i) => {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);

        const btn = document.createElement('div');
        btn.className = 'date-btn';
        if (i === appState.currentCheckinDay) btn.classList.add('active');
        
        btn.innerHTML = `
          <div class="date-btn-day">${name}</div>
          <div class="date-btn-date">${date.getMonth() + 1}/${date.getDate()}</div>
        `;
        
        btn.onclick = () => {
          appState.currentCheckinDay = i;
          renderDateSelector();
          renderCheckinList();
        };

        container.appendChild(btn);
      });
    }

    function renderCheckinList() {
      const container = document.getElementById('checkinList');
      container.innerHTML = '';

      const day = appState.currentCheckinDay;
      const plan = appState.weekPlan[day] || {};

      for (let hour = 7; hour <= 23; hour++) {
        const task = plan[hour];
        const checkin = appState.weekCheckin[day]?.[hour];

        if (!task) continue;

        const block = document.createElement('div');
        block.className = 'time-block';

        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-block-time';
        timeLabel.textContent = `${hour}:00`;

        const content = document.createElement('div');
        content.className = 'time-block-content';

        const tagEl = document.createElement('div');
        tagEl.className = 'time-block-tag';
        const cat = appState.categories[task.category];
        tagEl.style.background = cat.color;
        tagEl.textContent = task.tag;

        const checkBtn = document.createElement('div');
        checkBtn.className = 'check-btn';

        if (checkin === 'done') {
          checkBtn.classList.add('done');
          checkBtn.textContent = 'âœ“';
        } else if (checkin && checkin !== 'done') {
          checkBtn.classList.add('undone');
          checkBtn.textContent = 'âœ—';
        }

        checkBtn.onclick = () => {
          if (!checkin) {
            appState.weekCheckin[day] = appState.weekCheckin[day] || {};
            appState.weekCheckin[day][hour] = 'done';
            saveCheckinData(day, hour, { status: 'done' });
          } else if (checkin === 'done') {
            appState.weekCheckin[day][hour] = {
              status: 'undone',
              reason: { category: 'custom', tag: 'å…¶ä»–' }
            };
            saveCheckinData(day, hour, { 
              status: 'undone',
              reason: { category: 'custom', tag: 'å…¶ä»–' }
            });
          } else {
            delete appState.weekCheckin[day][hour];
          }
          renderCheckinList();
        };

        content.appendChild(tagEl);
        block.appendChild(timeLabel);
        block.appendChild(content);
        block.appendChild(checkBtn);
        container.appendChild(block);
      }
    }

    function checkFirstUse() {
      const hasUsed = localStorage.getItem('lifeScriptHasUsed');
      if (!hasUsed) {
        document.getElementById('intro-layer').style.display = 'flex';
      } else {
        document.getElementById('intro-layer').classList.add('hide');
      }
    }

    let currentSlide = 0;
    function nextSlide() {
      const slides = document.querySelectorAll('.intro-slide');
      slides[currentSlide].style.display = 'none';
      currentSlide = (currentSlide + 1) % slides.length;
      slides[currentSlide].style.display = 'block';
      updateDots();
    }

    function goToSlide(index) {
      const slides = document.querySelectorAll('.intro-slide');
      slides[currentSlide].style.display = 'none';
      currentSlide = index;
      slides[currentSlide].style.display = 'block';
      updateDots();
    }

    function updateDots() {
      const dots = document.querySelectorAll('.intro-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentSlide);
      });
    }

    function startApp() {
      localStorage.setItem('lifeScriptHasUsed', 'true');
      document.getElementById('intro-layer').classList.add('hide');
    }

    function switchPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(`page-${page}`).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    function switchReviewView(view) {
      document.getElementById('weekView').style.display = view === 'week' ? 'block' : 'none';
      document.getElementById('monthView').style.display = view === 'month' ? 'block' : 'none';
    }

    function updateAPIProvider() {
      const provider = document.getElementById('apiProvider').value;
      const label = document.getElementById('apiKeyLabel');
      label.textContent = provider === 'deepseek' ? 'DeepSeek API Key' : 'æ™ºè°±AI API Key';
    }

    function editUserName() {
      const newName = prompt('è¯·è¾“å…¥æ‚¨çš„å§“å:', appState.userName);
      if (newName && newName.trim()) {
        appState.userName = newName.trim();
        document.getElementById('userNameDisplay').textContent = appState.userName;
        saveUserData();
      }
    }

    function saveAPIKey() {
      appState.apiKey = document.getElementById('apiKey').value;
      appState.apiProvider = document.getElementById('apiProvider').value;
      saveUserData();
      alert('APIé…ç½®å·²ä¿å­˜');
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… DOMContentLoaded å·²è§¦å‘');
      
      // ç»‘å®šè®¤è¯è¡¨å•
      const authForm = document.getElementById('authForm');
      const authToggleBtn = document.getElementById('authToggleBtn');
      
      console.log('ğŸ“ authForm å…ƒç´ :', authForm);
      console.log('ğŸ“ authToggleBtn å…ƒç´ :', authToggleBtn);
      
      if (authForm) {
        authForm.addEventListener('submit', handleAuthSubmit);
        console.log('âœ… authForm submit äº‹ä»¶å·²ç»‘å®š');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ° authForm å…ƒç´ ');
      }
      
      if (authToggleBtn) {
        authToggleBtn.addEventListener('click', toggleAuthMode);
        console.log('âœ… authToggleBtn click äº‹ä»¶å·²ç»‘å®š');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ° authToggleBtn å…ƒç´ ');
      }
      
      // ç»‘å®šå¤ç›˜ç¬”è®°ä¿å­˜
      ['highlight', 'NG', 'thinking'].forEach(key => {
        const el = document.getElementById(`review${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (el) {
          el.addEventListener('input', () => {
            appState.reviewNotes[key === 'NG' ? 'ng' : key] = el.value;
            saveUserData();
          });
        }
      });

      // åŠ è½½APIé…ç½®
      document.getElementById('apiKey').value = appState.apiKey || '';
      document.getElementById('apiProvider').value = appState.apiProvider || 'deepseek';

      // æ£€æŸ¥è®¤è¯çŠ¶æ€
      console.log('ğŸ” æ£€æŸ¥è®¤è¯çŠ¶æ€...');
      checkAuth();
    });

    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        currentUser = session.user;
        showApp();
      } else if (event === 'SIGNED_OUT') {
        currentUser = null;
        showAuth();
      }
    });
  </script>
</body>
</html>
