<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="äººç”Ÿè„šæœ¬">
  <meta name="theme-color" content="#667eea">
  <title>äººç”Ÿè„šæœ¬ - Life Script</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
    
    :root {
      --bg: #FDFCF8;
      --text: #2C2C2C;
      --sub: #8B8B8B;
      --border: #E5E3DC;
      
      /* å››è±¡é™é¢œè‰² */
      --health: #A8D5BA;
      --family: #FFD4A3;
      --work: #A5C9E0;
      --growth: #E0B3D9;
      --custom: #D4D4D4;
      
      /* çŠ¶æ€é¢œè‰² */
      --done: #95D7AE;
      --undone: #F4A7A7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Noto Sans SC', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* ========== å¼•å¯¼å±‚ ========== */
    #intro-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.8s ease;
    }

    #intro-layer.hide {
      opacity: 0;
      pointer-events: none;
    }

    .intro-container {
      width: 100%;
      max-width: 500px;
      height: 100vh;
      position: relative;
      text-align: center;
      padding: 80px 30px;
      overflow: hidden;
    }

    .intro-slide {
      animation: fadeIn 0.5s;
    }

    .intro-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ddd;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0 4px;
    }

    .intro-dot.active {
      width: 24px;
      border-radius: 4px;
      background: #667eea;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .start-btn {
      padding: 14px 40px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 30px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 15px;
      letter-spacing: 3px;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .start-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    /* ========== é¡¶éƒ¨å¯¼èˆª ========== */
    .header {
      position: sticky;
      top: 0;
      padding: 20px;
      background: rgba(253, 252, 248, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .user-name {
      font-family: 'Noto Serif SC', serif;
      font-size: 18px;
      font-weight: 600;
    }

    .user-name input {
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      color: var(--text);
      width: 150px;
      border-bottom: 1px dashed var(--border);
    }

    .user-name input:focus {
      outline: none;
      border-bottom-color: var(--text);
    }

    .motto {
      font-family: 'Noto Serif SC', serif;
      font-size: 13px;
      color: var(--sub);
      font-style: italic;
      margin-top: 8px;
    }

    .week-info {
      display: flex;
      gap: 10px;
      font-size: 11px;
      color: var(--sub);
      flex-wrap: wrap;
    }

    .week-info span {
      padding: 4px 10px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    /* ========== é¡µé¢å®¹å™¨ ========== */
    .page-container {
      min-height: calc(100vh - 200px);
      padding: 20px;
      padding-bottom: 100px;
    }

    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========== å‘¨è®¡åˆ’é¡µé¢ ========== */
    .section-title {
      font-family: 'Noto Serif SC', serif;
      font-size: 20px;
      font-weight: 600;
      margin: 30px 0 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-fill {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .category-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .category-btn {
      padding: 12px 8px;
      border: 2px solid transparent;
      border-radius: 12px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .category-btn.active {
      border-color: var(--text);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .tag-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .tag-btn {
      padding: 8px 14px;
      background: #f5f5f5;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-btn.active {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }

    .tag-btn:hover {
      transform: translateY(-1px);
    }

    .batch-hint {
      font-size: 12px;
      color: var(--sub);
      text-align: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    /* å‘¨è§†å›¾è¡¨æ ¼ */
    .week-table-wrapper {
      overflow-x: auto;
      margin: 20px 0;
      border-radius: 16px;
      background: white;
      padding: 15px;
      border: 1px solid var(--border);
    }

    .week-table {
      display: grid;
      grid-template-columns: 50px repeat(7, 1fr);
      gap: 4px;
      min-width: 100%;
    }

    .week-header {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      padding: 10px 5px;
      background: #f8f8f8;
      border-radius: 8px;
    }

    .week-header.today {
      background: var(--text);
      color: white;
    }

    .time-label {
      font-size: 10px;
      color: var(--sub);
      text-align: center;
      padding: 8px 0;
      font-family: monospace;
    }

    .time-cell {
      min-height: 35px;
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .time-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .time-cell.filled {
      font-weight: 500;
      border: none;
    }

    .time-cell.today-col {
      border: 2px solid var(--text);
    }

    /* ========== ä»Šæ—¥æ‰“å¡ ========== */
    .checkin-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .time-block {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .time-block:last-child {
      border-bottom: none;
    }

    .time-block-time {
      font-family: monospace;
      font-size: 14px;
      font-weight: 600;
      min-width: 60px;
      color: var(--sub);
    }

    .time-block-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-block-tag {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      flex: 1;
    }

    .time-block-tag.empty {
      background: #f5f5f5;
      color: var(--sub);
    }

    .check-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .check-btn.done {
      background: var(--done);
      border-color: var(--done);
    }

    .check-btn.undone {
      background: var(--undone);
      border-color: var(--undone);
    }

    .check-btn:hover {
      transform: scale(1.1);
    }

    /* ========== å‘¨å¤ç›˜ ========== */
    .review-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .review-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .review-input {
      width: 100%;
      border: 1px solid var(--border);
      background: #fafafa;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }

    .review-input:focus {
      outline: none;
      border-color: var(--text);
      background: white;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--sub);
    }

    .category-breakdown {
      margin-top: 20px;
    }

    .category-bar {
      margin-bottom: 15px;
    }

    .category-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .category-bar-track {
      height: 24px;
      background: #f5f5f5;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .category-bar-fill {
      height: 100%;
      transition: width 0.6s ease;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      color: white;
      font-weight: 600;
    }

    /* AI åˆ†æ */
    .ai-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      margin-bottom: 20px;
    }

    .ai-btn {
      width: 100%;
      padding: 15px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .ai-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .ai-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .ai-result {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.8;
      backdrop-filter: blur(10px);
      display: none;
      white-space: pre-line; /* ä¿ç•™æ¢è¡Œç¬¦ */
    }

    .ai-result.show {
      display: block;
      animation: slideDown 0.4s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========== å·¥å…·é¡µé¢ ========== */
    .tool-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .tool-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .category-config {
      margin-bottom: 20px;
    }

    .category-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #fafafa;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .color-picker {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid var(--border);
      cursor: pointer;
    }

    .category-name-input {
      flex: 1;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-item {
      padding: 6px 12px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tag-remove {
      cursor: pointer;
      color: var(--sub);
      font-weight: 600;
    }

    .tag-remove:hover {
      color: var(--text);
    }

    .add-tag-input {
      padding: 6px 12px;
      border: 1px dashed var(--border);
      border-radius: 16px;
      font-size: 12px;
      width: 120px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--text);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #f5f5f5;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* ========== åº•éƒ¨å¯¼èˆª ========== */
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 10px;
    }

    .nav-icon {
      font-size: 24px;
      margin-bottom: 4px;
      display: block;
    }

    .nav-label {
      font-size: 11px;
      color: var(--sub);
    }

    .nav-item.active .nav-label {
      color: var(--text);
      font-weight: 600;
    }

    .nav-item:hover {
      transform: translateY(-2px);
    }

    /* ========== æ¨¡æ€æ¡† ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal {
      background: white;
      border-radius: 20px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .modal-field {
      margin-bottom: 15px;
    }

    .modal-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .modal-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    /* ========== å“åº”å¼ ========== */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .category-selector {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ========== å·¥å…·æç¤º ========== */
    .hint {
      font-size: 12px;
      color: var(--sub);
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 3px solid var(--text);
    }

    /* æ—¥æœŸé€‰æ‹©å™¨ */
    .date-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .date-btn {
      min-width: 80px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
    }

    .date-btn.active {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }

    .date-btn-day {
      font-size: 11px;
      color: var(--sub);
      margin-bottom: 3px;
    }

    .date-btn.active .date-btn-day {
      color: rgba(255,255,255,0.8);
    }

    .date-btn-date {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- å¼•å¯¼å±‚ -->
  <div id="intro-layer">
    <div class="intro-container" id="introContainer">
      <!-- ç¬¬1é¡µ:æ¬¢è¿é¡µ -->
      <div class="intro-slide" data-slide="0">
        <div style="font-size:80px; margin-bottom:30px;">ğŸ¬</div>
        <h2 style="font-size:32px; font-weight:700; margin-bottom:15px; font-family: 'Noto Serif SC', serif;">äººç”Ÿè„šæœ¬</h2>
        <p style="font-size:16px; color:#666; margin-bottom:40px;">æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»<br>ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼”</p>
        <div style="font-size:18px; font-weight:600; margin-bottom:20px; color:#667eea;">è¿™é‡Œæˆ‘ä»¬å°†æ—¶é—´åˆ†æˆå››ç±»</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; max-width:300px; margin:0 auto;">
          <div style="background:#A8D5BA; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ’ª</div>
            <div style="font-size:14px;">å¥åº·ä¹ æƒ¯</div>
          </div>
          <div style="background:#FFD4A3; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ </div>
            <div style="font-size:14px;">å®¶åº­æ—¶é—´</div>
          </div>
          <div style="background:#A5C9E0; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ’¼</div>
            <div style="font-size:14px;">å·¥ä½œæ—¶é—´</div>
          </div>
          <div style="background:#E0B3D9; padding:20px; border-radius:12px; text-align:center;">
            <div style="font-size:28px; margin-bottom:8px;">ğŸ“š</div>
            <div style="font-size:14px;">è‡ªæˆ‘æˆé•¿</div>
          </div>
        </div>
      </div>

      <!-- ç¬¬2é¡µ:ç†å¿µ -->
      <div class="intro-slide" data-slide="1" style="display:none;">
        <div style="font-size:80px; margin-bottom:30px;">ğŸ­</div>
        <h2 style="font-size:28px; font-weight:700; margin-bottom:20px;">æ¼”å‘˜+å¯¼æ¼”çš„åŒé‡è§†è§’</h2>
        <div style="text-align:left; max-width:320px; margin:0 auto; font-size:15px; line-height:1.9; color:#555;">
          <p style="margin-bottom:20px;"><strong style="color:#667eea; font-size:16px;">80%å›ºå®š,20%çµæ´»</strong></p>
          <p>Â· å›ºå®š80%çš„æ—¥å¸¸åŠ¨ä½œ,å»ºç«‹ç§©åºæ„Ÿ</p>
          <p>Â· ä¸ºé•¿æœŸç›®æ ‡ç•™å‡ºæ—¶é—´</p>
          <p>Â· åŸ¹å…»ç»ˆèº«ä¹ æƒ¯</p>
          <p>Â· æå‡åº”å¯¹æ··ä¹±çš„èƒ½åŠ›</p>
        </div>
        <div style="margin-top:30px; padding:15px; background:#E8F5E9; border-radius:12px; font-size:13px; color:#4CAF50; text-align:left; max-width:320px; margin:30px auto 0;">
          <div style="font-weight:600; margin-bottom:8px;">ğŸ’¡ çŸ¥è¡Œåˆä¸€ç‡å°è´´å£«</div>
          <div style="font-size:12px; line-height:1.6;">
            Â· ç†æƒ³åŒºé—´æ˜¯ 75-85%,ä¸æ˜¯100%<br>
            Â· é€‚åº¦çš„æœªå®Œæˆè¯´æ˜ä½ åœ¨æŒ‘æˆ˜è‡ªå·±<br>
            Â· è¿‡é«˜å¯èƒ½è®¡åˆ’å¤ªä¿å®ˆ,è¿‡ä½éœ€è¦è°ƒæ•´
          </div>
        </div>
        <div style="margin-top:15px; padding:20px; background:#f5f5f5; border-radius:12px; font-size:14px; color:#999;">
          å‘¨è®¡åˆ’ â†’ æ—¥æ‰“å¡ â†’ å‘¨å¤ç›˜
        </div>
      </div>

      <!-- ç¬¬3é¡µ:ä½¿ç”¨æ–¹æ³• -->
      <div class="intro-slide" data-slide="2" style="display:none;">
        <div style="font-size:80px; margin-bottom:30px;">ğŸ“</div>
        <h2 style="font-size:28px; font-weight:700; margin-bottom:30px;">ä¸‰æ­¥å¼€å§‹ä½ çš„äººç”Ÿå‰§æœ¬</h2>
        <div style="text-align:left; max-width:320px; margin:0 auto;">
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div style="width:40px; height:40px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; flex-shrink:0;">1</div>
            <div>
              <div style="font-weight:600; margin-bottom:5px;">å‘¨ä¸€åˆ¶å®šå‰§æœ¬</div>
              <div style="font-size:13px; color:#666;">åœ¨"å‘¨è®¡åˆ’"é¡µæ’ç­,å›ºå®š80%çš„æ—¶é—´</div>
            </div>
          </div>
          <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div style="width:40px; height:40px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; flex-shrink:0;">2</div>
            <div>
              <div style="font-weight:600; margin-bottom:5px;">æ¯å¤©æ‰§è¡Œæ‰“å¡</div>
              <div style="font-size:13px; color:#666;">åœ¨"ä»Šæ—¥æ‰“å¡"é¡µè®°å½•,å®Œæˆâœ“,æœªå®Œæˆâœ—</div>
            </div>
          </div>
          <div style="display:flex; gap:15px;">
            <div style="width:40px; height:40px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; flex-shrink:0;">3</div>
            <div>
              <div style="font-weight:600; margin-bottom:5px;">å‘¨æ—¥å¯¼æ¼”å¤ç›˜</div>
              <div style="font-size:13px; color:#666;">åœ¨"å‘¨å¤ç›˜"é¡µåˆ†æ,çŸ¥è¡Œåˆä¸€ç‡+AIæ´å¯Ÿ</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç¬¬4é¡µ:å¼€å§‹ -->
      <div class="intro-slide" data-slide="3" style="display:none;">
        <div style="font-size:80px; margin-bottom:30px;">ğŸš€</div>
        <h2 style="font-size:28px; font-weight:700; margin-bottom:20px;">å‡†å¤‡å¥½äº†å—?</h2>
        <p style="font-size:16px; color:#666; margin-bottom:40px;">è®©æˆ‘ä»¬å¼€å¯ä½ çš„äººç”Ÿå‰§æœ¬ä¹‹æ—…<br>ä»è¾“å…¥ä½ çš„åå­—å¼€å§‹</p>
        <button class="start-btn" onclick="startApp()">è¿›å…¥ç‰‡åœº</button>
      </div>

      <!-- å¯¼èˆªç‚¹å’ŒæŒ‰é’® -->
      <div style="position:absolute; bottom:100px; left:0; right:0; display:flex; justify-content:center; align-items:center; gap:10px;">
        <span class="intro-dot active" data-index="0" onclick="goToSlide(0)"></span>
        <span class="intro-dot" data-index="1" onclick="goToSlide(1)"></span>
        <span class="intro-dot" data-index="2" onclick="goToSlide(2)"></span>
        <span class="intro-dot" data-index="3" onclick="goToSlide(3)"></span>
      </div>

      <button onclick="nextSlide()" style="position:absolute; bottom:30px; right:30px; background:#667eea; color:white; border:none; padding:12px 30px; border-radius:25px; font-size:14px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(102,126,234,0.3);" id="nextBtn">ä¸‹ä¸€é¡µ</button>
      <button onclick="startApp()" style="position:absolute; top:30px; right:30px; background:transparent; color:#999; border:none; padding:8px 16px; font-size:14px; cursor:pointer;">è·³è¿‡</button>
    </div>
  </div>

  <!-- é¡¶éƒ¨ä¿¡æ¯ -->
  <div class="header">
    <div class="user-info">
      <div class="user-name">
        äººç”Ÿè„šæœ¬ - <span id="userNameDisplay" onclick="editUserName()" style="cursor:pointer; border-bottom:1px dashed transparent;">å¯¼æ¼”</span>
      </div>
    </div>
    <div class="motto">æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»ã€‚ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼”ã€‚</div>
    <div class="week-info">
      <span id="yearInfo">2025å¹´</span>
      <span id="weekNum">ç¬¬6å‘¨</span>
      <span id="dateRange">2æœˆ3æ—¥ - 2æœˆ9æ—¥</span>
    </div>
  </div>

  <!-- é¡µé¢å®¹å™¨ -->
  <div class="page-container">
    <!-- å‘¨è®¡åˆ’é¡µ -->
    <div id="page-plan" class="page active">
      <div class="section-title">ğŸ“‹ æœ¬å‘¨å‰§æœ¬</div>
      
      <!-- å¿«æ·å¡«å……å·¥å…· -->
      <div class="quick-fill">
        <div style="font-weight: 600; margin-bottom: 15px;">âš¡ å¿«æ·æ’ç­</div>
        
        <div class="category-selector" id="categorySelector">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="tag-selector" id="tagSelector">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="batch-hint">
          ğŸ’¡ é€‰æ‹©ç±»åˆ«å’Œæ ‡ç­¾å,ç‚¹å‡»ä¸‹æ–¹æ ¼å­å³å¯å¿«é€Ÿå¡«å……
        </div>
      </div>

      <!-- å‘¨è§†å›¾è¡¨æ ¼ -->
      <div class="week-table-wrapper">
        <div class="week-table" id="weekTable">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- ä»Šæ—¥æ‰“å¡é¡µ -->
    <div id="page-checkin" class="page">
      <div class="section-title">âœ… ä»Šæ—¥æ‰“å¡</div>
      
      <!-- æ—¥æœŸé€‰æ‹© -->
      <div class="date-selector" id="dateSelector">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>

      <div class="hint">
        ğŸ’¡ ç‚¹å‡» âœ“ è¡¨ç¤ºå®Œæˆ,âœ— è¡¨ç¤ºæœªå®Œæˆ(éœ€è¯´æ˜åŸå› )
      </div>

      <div class="checkin-card" id="checkinList">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- å‘¨å¤ç›˜é¡µ -->
    <div id="page-review" class="page">
      <!-- è§†å›¾åˆ‡æ¢ -->
      <div style="display:flex; gap:10px; margin-bottom:20px; background:white; padding:10px; border-radius:12px;">
        <button class="btn btn-secondary" id="viewWeekBtn" onclick="switchReviewView('week')" style="flex:1">æœ¬å‘¨</button>
        <button class="btn btn-secondary" id="viewMonthBtn" onclick="switchReviewView('month')" style="flex:1">æœ¬æœˆ</button>
      </div>

      <!-- å‘¨è§†å›¾ -->
      <div id="weekView">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div class="section-title" style="margin:0;">ğŸ“Š å‘¨åº¦å®¡è§†</div>
          <button class="btn btn-secondary" onclick="shareWeekReviewPage()" style="padding:8px 20px; font-size:14px;">ğŸ“¤ åˆ†äº«æ­¤é¡µ</button>
        </div>

      <!-- å®Œæˆç»Ÿè®¡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statCompletion">0%</div>
          <div class="stat-label">çŸ¥è¡Œåˆä¸€ç‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0/119</div>
          <div class="stat-label">å®Œæˆæ—¶æ®µ</div>
        </div>
      </div>

      <!-- æ—¶é—´åˆ†å¸ƒ -->
      <div class="review-section">
        <div class="review-label">â° æ—¶é—´åˆ†å¸ƒ</div>
        <div class="category-breakdown" id="categoryBreakdown">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- å‘¨å¤ç›˜è¡¨æ ¼ -->
      <div class="week-table-wrapper">
        <div style="font-weight: 600; margin-bottom: 10px;">æœ¬å‘¨æ‰§è¡Œæƒ…å†µ</div>
        <div class="week-table" id="reviewWeekTable">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- å¯¼æ¼”å¤ç›˜ -->
      <div class="review-section">
        <div class="review-label">ğŸŒŸ é«˜å…‰æ—¶åˆ» (Highlight)</div>
        <textarea class="review-input" id="reviewHighlight" placeholder="æœ¬å‘¨æœ€æ»¡æ„çš„è¡¨ç°..."></textarea>
      </div>

      <div class="review-section">
        <div class="review-label">ğŸ’£ ç©¿å¸®é•œå¤´ (NG)</div>
        <textarea class="review-input" id="reviewNG" placeholder="é—æ†¾æˆ–æœªå®Œæˆçš„äº‹..."></textarea>
      </div>

      <div class="review-section">
        <div class="review-label">ğŸ’¡ å¯¼æ¼”æ€è€ƒ (Thinking)</div>
        <textarea class="review-input" id="reviewThinking" placeholder="ä¸‹å‘¨å‰§æœ¬ä¼˜åŒ–æ–¹æ¡ˆ..."></textarea>
      </div>

      <!-- AI åˆ†æ -->
      <div class="ai-section">
        <div style="font-weight: 600; margin-bottom: 15px;">ğŸ§  AI æ·±åº¦æ´å¯Ÿ</div>
        <button class="ai-btn" id="aiBtn" onclick="analyzeWithAI()">
          <span id="aiBtnText">âœ¨ AI åˆ†ææœ¬å‘¨æ•°æ®</span>
        </button>
        <div class="ai-result" id="aiResult"></div>
      </div>

      <!-- åˆ†äº«æŒ‰é’® -->
      <div class="review-section">
        <div style="font-weight: 600; margin-bottom: 15px;">ğŸ“¤ åˆ†äº«é€‰é¡¹</div>
        
        <!-- å¿«æ·åˆ†äº« -->
        <div style="margin-bottom:20px;">
          <div style="font-size:13px; color:#999; margin-bottom:10px;">å¿«æ·åˆ†äº«</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn btn-secondary" onclick="shareWeekPlan()">ğŸ“‹ å‘¨è®¡åˆ’</button>
            <button class="btn btn-secondary" onclick="shareWeekReview()">âœ… æ‰§è¡Œæƒ…å†µ</button>
            <button class="btn btn-secondary" onclick="shareAIInsight()">ğŸ§  AIæ´å¯Ÿ</button>
            <button class="btn btn-secondary" onclick="shareStatCard()">ğŸ“Š æ•°æ®å¡ç‰‡</button>
          </div>
        </div>

        <!-- ç»„åˆåˆ†äº« -->
        <div style="background:#f9f9f9; padding:15px; border-radius:12px;">
          <div style="font-size:13px; color:#999; margin-bottom:10px;">âœ¨ ç»„åˆåˆ†äº« (å¤šé€‰)</div>
          <div style="margin-bottom:12px;">
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px; cursor:pointer;">
              <input type="checkbox" id="shareOpt1" checked style="width:18px; height:18px;">
              <span style="font-size:14px;">å‘¨åº¦å®¡è§†(çŸ¥è¡Œåˆä¸€ç‡)</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px; cursor:pointer;">
              <input type="checkbox" id="shareOpt2" checked style="width:18px; height:18px;">
              <span style="font-size:14px;">æ—¶é—´åˆ†å¸ƒ</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px; cursor:pointer;">
              <input type="checkbox" id="shareOpt3" style="width:18px; height:18px;">
              <span style="font-size:14px;">å¤ç›˜ç¬”è®°</span>
            </label>
          </div>
          <button class="btn btn-primary" onclick="shareCustomCard()" style="width:100%;">ğŸ¬ ç”Ÿæˆè‡ªå®šä¹‰å¡ç‰‡</button>
        </div>
      </div>
      </div><!-- ç»“æŸweekView -->

      <!-- æœˆè§†å›¾ -->
      <div id="monthView" style="display:none;">
        <div class="section-title">ğŸ“… æœˆåº¦æ€»è§ˆ</div>

        <!-- æœˆåº¦ç»Ÿè®¡ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="monthCompletion">0%</div>
            <div class="stat-label">æœˆåº¦çŸ¥è¡Œåˆä¸€ç‡</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="monthTotal">0/0</div>
            <div class="stat-label">å®Œæˆ/è®¡åˆ’</div>
          </div>
        </div>

        <!-- å‘¨åº¦è¶‹åŠ¿ -->
        <div class="review-section">
          <div class="review-label">ğŸ“ˆ å‘¨åº¦è¶‹åŠ¿</div>
          <div id="weekTrend" style="padding:20px 0;">
            <!-- åŠ¨æ€ç”ŸæˆæŠ˜çº¿å›¾ -->
          </div>
        </div>

        <!-- æœˆåº¦æ—¶é—´åˆ†å¸ƒé¥¼å›¾ -->
        <div class="review-section">
          <div class="review-label">ğŸ¥§ æ—¶é—´åˆ†å¸ƒ</div>
          <div style="display:flex; justify-content:center; padding:20px;">
            <canvas id="monthPieChart" width="300" height="300"></canvas>
          </div>
          <div id="monthCategoryList"></div>
        </div>

        <!-- æœˆåº¦å¤ç›˜ -->
        <div class="review-section">
          <div class="review-label">ğŸŒŸ æœ¬æœˆæœ€å¤§æ”¶è·</div>
          <textarea class="review-input" id="monthAchievement" rows="3" placeholder="è¿™ä¸ªæœˆæœ€æ»¡æ„çš„æˆå°±..."></textarea>
        </div>

        <div class="review-section">
          <div class="review-label">âš ï¸ æœ¬æœˆæœ€å¤§æŒ‘æˆ˜</div>
          <textarea class="review-input" id="monthChallenge" rows="3" placeholder="é‡åˆ°çš„å›°éš¾å’ŒæŒ‘æˆ˜..."></textarea>
        </div>

        <div class="review-section">
          <div class="review-label">ğŸ¯ ä¸‹æœˆä¸‰å¤§ç›®æ ‡</div>
          <textarea class="review-input" id="monthGoals" rows="3" placeholder="1. ...\n2. ...\n3. ..."></textarea>
        </div>

        <!-- æœˆåº¦AIåˆ†æ -->
        <div class="ai-section">
          <div style="font-weight: 600; margin-bottom: 15px;">ğŸ§  æœˆåº¦AIæ´å¯Ÿ</div>
          <button class="ai-btn" id="monthAiBtn" onclick="analyzeMonth()">
            <span id="monthAiBtnText">âœ¨ AI åˆ†ææœ¬æœˆæ•°æ®</span>
          </button>
          <div class="ai-result" id="monthAIResult"></div>
        </div>

        <!-- æœˆåº¦åˆ†äº« -->
        <div class="review-section">
          <div style="font-weight: 600; margin-bottom: 15px;">ğŸ“¤ åˆ†äº«é€‰é¡¹</div>
          
          <!-- å¿«æ·åˆ†äº« -->
          <div style="margin-bottom:15px; font-size:13px; color:#999;">å¿«æ·åˆ†äº«</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <button class="btn btn-secondary" onclick="shareMonthReviewPage()">ğŸ“Š æœˆåº¦å®¡è§†</button>
            <button class="btn btn-secondary" onclick="shareMonthAIInsight()">ğŸ§  AIæ´å¯Ÿ</button>
            <button class="btn btn-secondary" onclick="shareMonthTrendCard()">ğŸ“ˆ è¶‹åŠ¿å›¾</button>
            <button class="btn btn-secondary" onclick="shareMonthSummaryCard()">ğŸ“‹ æ•°æ®æ€»ç»“</button>
          </div>
        </div>
      </div><!-- ç»“æŸmonthView -->
    </div>

    <!-- å·¥å…·é¡µ -->
    <div id="page-tools" class="page">
      <div class="section-title">âš™ï¸ è®¾ç½®</div>

      <!-- åˆ†ç±»é…ç½® -->
      <div class="tool-section">
        <div class="tool-title">ğŸ¨ è‡ªå®šä¹‰åˆ†ç±»</div>
        <div class="hint">
          ğŸ’¡ å‚è€ƒç¤ºä¾‹:å¥åº·ä¹ æƒ¯ã€å®¶åº­æ—¶é—´ã€å·¥ä½œæ—¶é—´ã€è‡ªæˆ‘æˆé•¿ã€ä¼‘é—²å¨±ä¹
        </div>
        <div id="categoryConfig">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æ•°æ®ç®¡ç† -->
      <div class="tool-section">
        <div class="tool-title">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        </div>
      </div>

      <!-- API é…ç½® -->
      <div class="tool-section">
        <div class="tool-title">ğŸ”Œ AI é…ç½®</div>
        <div class="modal-field">
          <label class="modal-label">é€‰æ‹©AIå¹³å°</label>
          <select class="modal-select" id="apiProvider" onchange="updateAPIProvider()">
            <option value="deepseek">DeepSeek</option>
            <option value="zhipu">æ™ºè°±æ¸…è¨€ (GLM-4)</option>
          </select>
        </div>
        <div class="modal-field">
          <label class="modal-label" id="apiKeyLabel">DeepSeek API Key</label>
          <input type="text" class="modal-input" id="apiKey" placeholder="sk-...">
        </div>
        <button class="btn btn-primary" onclick="saveAPIKey()">ä¿å­˜é…ç½®</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <div class="nav-bar">
    <div class="nav-item active" onclick="switchPage('plan')">
      <span class="nav-icon">ğŸ“‹</span>
      <div class="nav-label">å‰§æœ¬å®‰æ’</div>
    </div>
    <div class="nav-item" onclick="switchPage('checkin')">
      <span class="nav-icon">âœ…</span>
      <div class="nav-label">ä»Šæ—¥æ‰“å¡</div>
    </div>
    <div class="nav-item" onclick="switchPage('review')">
      <span class="nav-icon">ğŸ“Š</span>
      <div class="nav-label">å¯¼æ¼”æ€»ç»“</div>
    </div>
    <div class="nav-item" onclick="switchPage('tools')">
      <span class="nav-icon">âš™ï¸</span>
      <div class="nav-label">å·¥å…·</div>
    </div>
  </div>

  <!-- ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-title">ç¼–è¾‘æ—¶æ®µ</div>
      <div class="modal-field">
        <label class="modal-label">é€‰æ‹©åˆ†ç±»</label>
        <select class="modal-select" id="modalCategory" onchange="updateModalTags()">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </select>
      </div>
      <div class="modal-field">
        <label class="modal-label">é€‰æ‹©æ ‡ç­¾</label>
        <select class="modal-select" id="modalTag">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </select>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTask()">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- æ‰“å¡è¯´æ˜æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="reasonModal">
    <div class="modal">
      <div class="modal-title">æœªå®ŒæˆåŸå› </div>
      <div class="modal-field">
        <label class="modal-label">å®é™…åšäº†ä»€ä¹ˆ?</label>
        <select class="modal-select" id="reasonCategory">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </select>
      </div>
      <div class="modal-field">
        <label class="modal-label">å…·ä½“æ ‡ç­¾</label>
        <select class="modal-select" id="reasonTag">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </select>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="closeReasonModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveReason()">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- åˆ†äº«å¡ç‰‡æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-title">æœ¬å‘¨å‰§æœ¬ Â· åˆ†äº«å¡ç‰‡</div>
      <div id="shareCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px 30px; color: white; position: relative; overflow: hidden;">
        <!-- è£…é¥°æ€§åœ†ç‚¹ -->
        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        
        <div style="position: relative; z-index: 1;">
          <div style="font-family: 'Noto Serif SC', serif; font-size: 28px; font-weight: 700; margin-bottom: 20px;">
            <span id="shareUserName"></span> çš„äººç”Ÿå‰§æœ¬
          </div>
          
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 30px;" id="shareWeekInfo"></div>
          
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 16px; padding: 25px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700;" id="shareCompletionRate"></div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">çŸ¥è¡Œåˆä¸€ç‡</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700;" id="shareCompleted"></div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">å®Œæˆæ—¶æ®µ</div>
              </div>
            </div>
            
            <div id="shareDistribution" style="font-size: 13px; line-height: 1.8;">
              <!-- åŠ¨æ€ç”Ÿæˆæ—¶é—´åˆ†å¸ƒ -->
            </div>
          </div>
          
          <div id="shareInsight" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; font-size: 13px; line-height: 1.8; font-style: italic; display: none;">
            <!-- AIæ´å¯Ÿæ‘˜è¦ -->
          </div>
          
          <div style="text-align: center; font-size: 11px; opacity: 0.6; margin-top: 30px;">
            äººç”Ÿè„šæœ¬ Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»
          </div>
        </div>
      </div>
      
      <div class="btn-group" style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeShareModal()">å…³é—­</button>
        <button class="btn btn-primary" onclick="downloadShareImage()">ä¿å­˜å›¾ç‰‡</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ========== æ•°æ®æ¨¡å‹ ==========
    const DEFAULT_CATEGORIES = {
      health: {
        name: 'å¥åº·ä¹ æƒ¯',
        color: '#A8D5BA',
        tags: ['å†¥æƒ³', 'è¿åŠ¨', 'ç‘œä¼½', 'ç¡çœ ', 'è¥å…»é¤']
      },
      family: {
        name: 'å®¶åº­æ—¶é—´',
        color: '#FFD4A3',
        tags: ['é™ªå­©å­', 'é™ªçˆ¶æ¯', 'å®¶åŠ¡', 'äº²å­æ´»åŠ¨']
      },
      work: {
        name: 'å·¥ä½œæ—¶é—´',
        color: '#A5C9E0',
        tags: ['åŠ ç­ç‹—', 'ä¼šè®®', 'é¡¹ç›®', 'å­¦ä¹ ']
      },
      growth: {
        name: 'è‡ªæˆ‘æˆé•¿',
        color: '#E0B3D9',
        tags: ['å†™ä½œ', 'é˜…è¯»', 'æ€è€ƒ', 'å­¦ä¹ ']
      },
      custom: {
        name: 'ä¼‘é—²å¨±ä¹',
        color: '#D4D4D4',
        tags: ['è¿½å‰§', 'æ¸¸æˆ', 'ç¤¾äº¤', 'è´­ç‰©']
      }
    };

    // åº”ç”¨çŠ¶æ€
    let appState = {
      userName: 'å‘¨å°ç™½',
      categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
      
      // æ–°æ•°æ®ç»“æ„:æŒ‰å‘¨å­˜å‚¨,keyä¸º"2026-W06"æ ¼å¼
      weeklyData: {}, // { "2026-W06": { plan: {}, checkin: {}, notes: {} } }
      
      // å…¼å®¹æ—§ç‰ˆæœ¬(é€æ­¥è¿ç§»)
      weekPlan: {}, 
      weekCheckin: {},
      reviewNotes: {
        highlight: '',
        ng: '',
        thinking: ''
      },
      
      apiKey: '',
      apiProvider: 'deepseek',
      currentDay: 6,
      currentEditCell: null,
      selectedCategory: 'health',
      selectedTag: null,
      currentCheckinDay: 6,
      currentWeekKey: '' // å½“å‰å‘¨æ ‡è¯†,å¦‚"2026-W06"
    };

    // ========== çŸ¥è¡Œåˆä¸€ç‡è¯„çº§ç³»ç»Ÿ ==========
    function getRatingInfo(rate) {
      if (rate >= 85) {
        return {
          level: 'å“è¶Š',
          icon: 'ğŸŒŸ',
          color: '#FFD700',
          message: 'æƒŠäººçš„è‡ªå¾‹!ä¸è¿‡ä¹Ÿè¦ç»™è‡ªå·±ç•™ç‚¹å¼¹æ€§ç©ºé—´å“¦',
          inIdealRange: false,
          encouragement: 'ä½ çš„æ‰§è¡ŒåŠ›è¶…ç¾¤!ä½†è®°ä½,é€‚åº¦çš„æœªå®Œæˆ(10-20%)åè€Œè¯´æ˜ä½ åœ¨æŒ‘æˆ˜è‡ªå·±'
        };
      } else if (rate >= 75) {
        return {
          level: 'ä¼˜ç§€',
          icon: 'ğŸ†',
          color: '#4CAF50',
          message: 'å®Œç¾çš„å¹³è¡¡!è¿™æ­£æ˜¯å¥åº·çš„çŸ¥è¡Œåˆä¸€ç‡',
          inIdealRange: true,
          encouragement: 'ä½ åœ¨ç†æƒ³åŒºé—´å†…!è®¡åˆ’æ—¢æœ‰æŒ‘æˆ˜æ€§åˆåˆ‡å®å¯è¡Œ,ç»§ç»­ä¿æŒ!'
        };
      } else if (rate >= 65) {
        return {
          level: 'è‰¯å¥½',
          icon: 'ğŸ‘',
          color: '#2196F3',
          message: 'ä¸é”™çš„å¼€å§‹!ç¨³å®šåå¯ä»¥æ…¢æ…¢æå‡',
          inIdealRange: false,
          encouragement: 'ç¨³å®šåœ¨è¿™ä¸ªæ°´å¹³,ç„¶åæ¯å‘¨æå‡2-3%,å¾ªåºæ¸è¿›æœ€æœ‰æ•ˆ'
        };
      } else if (rate >= 55) {
        return {
          level: 'åŠæ ¼',
          icon: 'âš ï¸',
          color: '#FF9800',
          message: 'è¿˜æœ‰è¿›æ­¥ç©ºé—´',
          inIdealRange: false,
          encouragement: 'è¯•ç€ä»æœ€å®¹æ˜“çš„3ä¸ªæ—¶æ®µå¼€å§‹ç¨³å®š?å°æ‰¿è¯ºæ›´å®¹æ˜“å»ºç«‹ä¿¡ä»»'
        };
      } else {
        return {
          level: 'éœ€æ”¹è¿›',
          icon: 'ğŸ”´',
          color: '#F44336',
          message: 'è®¡åˆ’å¯èƒ½å¤ªå¤šäº†',
          inIdealRange: false,
          encouragement: 'ä¸‹å‘¨è¯•è¯•å‡å°‘50%çš„è®¡åˆ’é‡,ä»å°‘é‡ç¨³å®šçš„æ‰¿è¯ºå¼€å§‹'
        };
      }
    }

    // ========== åˆå§‹åŒ– ==========
    function init() {
      // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
      checkFirstUse();
      
      loadData();
      updateWeekInfo();
      renderCategorySelector();
      renderWeekTable();
      renderDateSelector();
      renderCheckinList();
      renderCategoryConfig();
      
      // æ˜¾ç¤ºç”¨æˆ·å
      document.getElementById('userNameDisplay').textContent = appState.userName;

      // ç»‘å®šå¤ç›˜è¾“å…¥
      ['highlight', 'NG', 'thinking'].forEach(key => {
        const el = document.getElementById(`review${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (!el) {
          console.error(`æ‰¾ä¸åˆ°å…ƒç´ : review${key}`);
          return;
        }
        
        const stateKey = key === 'NG' ? 'ng' : key; // NGæ˜ å°„ä¸ºng
        el.value = appState.reviewNotes[stateKey] || '';
        
        // ä¸‰é‡ä¿éšœ:input(å®æ—¶), change, blur
        const saveNote = (e) => {
          appState.reviewNotes[stateKey] = e.target.value;
          console.log(`âœ… ä¿å­˜å¤ç›˜ç¬”è®° ${stateKey}:`, e.target.value.substring(0, 20) + '...'); // è°ƒè¯•æ—¥å¿—
          saveData();
        };
        
        el.addEventListener('input', saveNote); // å®æ—¶ä¿å­˜
        el.addEventListener('change', saveNote);
        el.addEventListener('blur', saveNote);
      });

      // ç»‘å®šAPIé…ç½®
      const apiKeyInput = document.getElementById('apiKey');
      apiKeyInput.value = appState.apiKey || '';
      
      const apiProvider = document.getElementById('apiProvider');
      apiProvider.value = appState.apiProvider || 'deepseek';
      updateAPIProvider();
    }

    function editUserName() {
      const newName = prompt('è¯·è¾“å…¥æ‚¨çš„å§“å:', appState.userName);
      if (newName && newName.trim()) {
        appState.userName = newName.trim();
        document.getElementById('userNameDisplay').textContent = appState.userName;
        saveData();
      }
    }

    // ========== å‘¨ä¿¡æ¯æ›´æ–° ==========
    function updateWeekInfo() {
      // è·å–åŒ—äº¬æ—¶é—´ (UTC+8)
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const beijingTime = new Date(utc + (3600000 * 8));
      
      const year = beijingTime.getFullYear();
      const weekNum = getWeekNumber(beijingTime);
      
      // ç”Ÿæˆå‘¨æ ‡è¯†
      appState.currentWeekKey = `${year}-W${String(weekNum).padStart(2, '0')}`;
      
      // è·å–æœ¬å‘¨ä¸€å’Œå‘¨æ—¥
      const dayOfWeek = beijingTime.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
      appState.currentDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // è½¬æ¢ä¸ºå‘¨ä¸€=0
      appState.currentCheckinDay = appState.currentDay;
      
      const monday = new Date(beijingTime);
      monday.setDate(beijingTime.getDate() - appState.currentDay);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      document.getElementById('yearInfo').textContent = `${year}å¹´`;
      document.getElementById('weekNum').textContent = `ç¬¬${weekNum}å‘¨`;
      document.getElementById('dateRange').textContent = 
        `${monday.getMonth() + 1}æœˆ${monday.getDate()}æ—¥ - ${sunday.getMonth() + 1}æœˆ${sunday.getDate()}æ—¥`;
      
      // åˆå§‹åŒ–æœ¬å‘¨æ•°æ®
      initCurrentWeekData();
    }
    
    // åˆå§‹åŒ–å½“å‰å‘¨æ•°æ®
    function initCurrentWeekData() {
      const weekKey = appState.currentWeekKey;
      
      // å¦‚æœweeklyDataä¸­æ²¡æœ‰æœ¬å‘¨æ•°æ®,å°è¯•ä»æ—§æ ¼å¼è¿ç§»
      if (!appState.weeklyData[weekKey]) {
        appState.weeklyData[weekKey] = {
          plan: appState.weekPlan || {},
          checkin: appState.weekCheckin || {},
          notes: {
            highlight: appState.reviewNotes?.highlight || '',
            ng: appState.reviewNotes?.ng || '',
            thinking: appState.reviewNotes?.thinking || ''
          }
        };
      }
      
      // åŒæ­¥åˆ°æ—§æ ¼å¼(å‘åå…¼å®¹)
      appState.weekPlan = appState.weeklyData[weekKey].plan || {};
      appState.weekCheckin = appState.weeklyData[weekKey].checkin || {};
      
      // é‡è¦:æ·±åº¦å¤åˆ¶notes,é¿å…å¼•ç”¨é—®é¢˜
      const savedNotes = appState.weeklyData[weekKey].notes || {};
      appState.reviewNotes = {
        highlight: savedNotes.highlight || '',
        ng: savedNotes.ng || '',
        thinking: savedNotes.thinking || ''
      };
    }
    
    // ä¿å­˜å½“å‰å‘¨æ•°æ®
    function saveCurrentWeekData() {
      const weekKey = appState.currentWeekKey;
      
      // ç¡®ä¿weeklyDataä¸­æœ‰æœ¬å‘¨æ•°æ®
      if (!appState.weeklyData[weekKey]) {
        appState.weeklyData[weekKey] = {};
      }
      
      // ä¿å­˜è®¡åˆ’å’Œæ‰“å¡æ•°æ®
      appState.weeklyData[weekKey].plan = appState.weekPlan;
      appState.weeklyData[weekKey].checkin = appState.weekCheckin;
      
      // é‡ç‚¹:ç¡®ä¿noteså¯¹è±¡å®Œæ•´ä¿å­˜
      appState.weeklyData[weekKey].notes = {
        highlight: appState.reviewNotes.highlight || '',
        ng: appState.reviewNotes.ng || '',
        thinking: appState.reviewNotes.thinking || ''
      };
      
      console.log('ä¿å­˜æœ¬å‘¨æ•°æ®:', weekKey, appState.weeklyData[weekKey].notes); // è°ƒè¯•æ—¥å¿—
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // ========== åˆ†ç±»é€‰æ‹©å™¨æ¸²æŸ“ ==========
    function renderCategorySelector() {
      const container = document.getElementById('categorySelector');
      container.innerHTML = '';
      
      Object.keys(appState.categories).forEach(key => {
        const cat = appState.categories[key];
        const btn = document.createElement('div');
        btn.className = 'category-btn';
        if (appState.selectedCategory === key) btn.classList.add('active');
        btn.style.background = cat.color;
        btn.textContent = cat.name;
        btn.onclick = () => selectCategory(key);
        container.appendChild(btn);
      });

      renderTagSelector();
    }

    function renderTagSelector() {
      const container = document.getElementById('tagSelector');
      container.innerHTML = '';
      
      const cat = appState.categories[appState.selectedCategory];
      if (!cat) return;

      cat.tags.forEach(tag => {
        const btn = document.createElement('div');
        btn.className = 'tag-btn';
        if (appState.selectedTag === tag) btn.classList.add('active');
        btn.textContent = tag;
        btn.onclick = () => selectTag(tag);
        container.appendChild(btn);
      });
    }

    function selectCategory(key) {
      appState.selectedCategory = key;
      appState.selectedTag = null;
      renderCategorySelector();
    }

    function selectTag(tag) {
      appState.selectedTag = tag;
      renderTagSelector();
    }

    // ========== å‘¨è§†å›¾è¡¨æ ¼ ==========
    function renderWeekTable() {
      const container = document.getElementById('weekTable');
      container.innerHTML = '';

      // è¡¨å¤´
      const headers = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
      headers.forEach((h, i) => {
        const cell = document.createElement('div');
        cell.className = 'week-header';
        if (i > 0 && i - 1 === appState.currentDay) cell.classList.add('today');
        cell.textContent = h;
        container.appendChild(cell);
      });

      // æ—¶é—´è¡Œ
      for (let hour = 7; hour <= 23; hour++) {
        // æ—¶é—´æ ‡ç­¾
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-label';
        timeLabel.textContent = `${hour}:00`;
        container.appendChild(timeLabel);

        // æ¯å¤©çš„æ ¼å­
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = 'time-cell';
          if (day === appState.currentDay) cell.classList.add('today-col');

          const task = appState.weekPlan[day]?.[hour];
          if (task) {
            const cat = appState.categories[task.category];
            cell.style.background = cat.color;
            cell.textContent = task.tag;
            cell.classList.add('filled');
          }

          cell.onclick = () => editCell(day, hour);
          container.appendChild(cell);
        }
      }
    }

    function editCell(day, hour) {
      // å¦‚æœå·²é€‰æ‹©æ ‡ç­¾,ç›´æ¥å¡«å……
      if (appState.selectedTag && appState.selectedCategory) {
        if (!appState.weekPlan[day]) appState.weekPlan[day] = {};
        appState.weekPlan[day][hour] = {
          category: appState.selectedCategory,
          tag: appState.selectedTag
        };
        saveData();
        renderWeekTable();
        return;
      }

      // å¦åˆ™æ‰“å¼€ç¼–è¾‘æ¡†
      appState.currentEditCell = { day, hour };
      const task = appState.weekPlan[day]?.[hour];
      
      // å¡«å……æ¨¡æ€æ¡†
      const categorySelect = document.getElementById('modalCategory');
      categorySelect.innerHTML = '';
      Object.keys(appState.categories).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = appState.categories[key].name;
        if (task && task.category === key) option.selected = true;
        categorySelect.appendChild(option);
      });

      updateModalTags();
      if (task) {
        document.getElementById('modalTag').value = task.tag;
      }

      document.getElementById('editModal').classList.add('show');
    }

    function updateModalTags() {
      const categoryKey = document.getElementById('modalCategory').value;
      const tagSelect = document.getElementById('modalTag');
      tagSelect.innerHTML = '';

      const cat = appState.categories[categoryKey];
      cat.tags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagSelect.appendChild(option);
      });
    }

    function saveTask() {
      const { day, hour } = appState.currentEditCell;
      const category = document.getElementById('modalCategory').value;
      const tag = document.getElementById('modalTag').value;

      if (!appState.weekPlan[day]) appState.weekPlan[day] = {};
      appState.weekPlan[day][hour] = { category, tag };
      
      saveData();
      renderWeekTable();
      closeModal();
    }

    function closeModal() {
      document.getElementById('editModal').classList.remove('show');
    }

    // ========== æ—¥æœŸé€‰æ‹©å™¨ ==========
    function renderDateSelector() {
      const container = document.getElementById('dateSelector');
      container.innerHTML = '';

      const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
      const now = new Date();
      const dayOfWeek = now.getDay();
      const monday = new Date(now);
      monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

      days.forEach((name, i) => {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);

        const btn = document.createElement('div');
        btn.className = 'date-btn';
        if (i === appState.currentCheckinDay) btn.classList.add('active');
        
        btn.innerHTML = `
          <div class="date-btn-day">${name}</div>
          <div class="date-btn-date">${date.getMonth() + 1}/${date.getDate()}</div>
        `;
        
        btn.onclick = () => {
          appState.currentCheckinDay = i;
          renderDateSelector();
          renderCheckinList();
        };

        container.appendChild(btn);
      });
    }

    // ========== ä»Šæ—¥æ‰“å¡åˆ—è¡¨ ==========
    function renderCheckinList() {
      const container = document.getElementById('checkinList');
      container.innerHTML = '';

      const day = appState.currentCheckinDay;
      const plan = appState.weekPlan[day] || {};
      
      // è·å–å½“å‰åŒ—äº¬æ—¶é—´
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const beijingTime = new Date(utc + (3600000 * 8));
      const currentDayOfWeek = beijingTime.getDay() === 0 ? 6 : beijingTime.getDay() - 1;
      const currentHour = beijingTime.getHours();
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯æœªæ¥æ—¶é—´
      const isFutureDay = day > currentDayOfWeek;

      for (let hour = 7; hour <= 23; hour++) {
        const task = plan[hour];
        const checkin = appState.weekCheckin[day]?.[hour];
        
        // åˆ¤æ–­è¿™ä¸ªæ—¶æ®µæ˜¯å¦æ˜¯æœªæ¥
        const isFuture = isFutureDay || (day === currentDayOfWeek && hour > currentHour);

        const block = document.createElement('div');
        block.className = 'time-block';

        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-block-time';
        timeLabel.textContent = `${hour}:00`;

        const content = document.createElement('div');
        content.className = 'time-block-content';

        const tagEl = document.createElement('div');
        tagEl.className = 'time-block-tag';

        if (task) {
          const cat = appState.categories[task.category];
          tagEl.style.background = cat.color;
          tagEl.textContent = task.tag;
          
          // å¦‚æœæ˜¯æœªæ¥æ—¶é—´,æ˜¾ç¤ºç°è‰²
          if (isFuture) {
            tagEl.style.opacity = '0.4';
            tagEl.textContent = task.tag + ' (æœªåˆ°æ—¶é—´)';
          }
        } else {
          tagEl.classList.add('empty');
          tagEl.textContent = 'æœªå®‰æ’';
        }

        const checkBtn = document.createElement('div');
        checkBtn.className = 'check-btn';

        if (task) {
          if (isFuture) {
            // æœªæ¥æ—¶é—´,ç°è‰²ä¸å¯ç‚¹å‡»
            checkBtn.style.opacity = '0.3';
            checkBtn.style.cursor = 'not-allowed';
            checkBtn.style.background = '#e0e0e0';
            checkBtn.style.borderColor = '#e0e0e0';
          } else {
            // è¿‡å»å’Œç°åœ¨çš„æ—¶é—´,å¯ä»¥æ‰“å¡
            if (checkin === 'done') {
              checkBtn.classList.add('done');
              checkBtn.textContent = 'âœ“';
            } else if (checkin && checkin !== 'done') {
              checkBtn.classList.add('undone');
              checkBtn.textContent = 'âœ—';
            }
            checkBtn.onclick = () => toggleCheck(day, hour, checkin);
          }
        }

        content.appendChild(tagEl);
        block.appendChild(timeLabel);
        block.appendChild(content);
        if (task) block.appendChild(checkBtn);

        container.appendChild(block);
      }
    }

    function toggleCheck(day, hour, currentStatus) {
      if (!currentStatus) {
        // æ ‡è®°ä¸ºå®Œæˆ
        if (!appState.weekCheckin[day]) appState.weekCheckin[day] = {};
        appState.weekCheckin[day][hour] = 'done';
      } else if (currentStatus === 'done') {
        // æ ‡è®°ä¸ºæœªå®Œæˆ,éœ€è¦å¡«å†™åŸå› 
        appState.currentEditCell = { day, hour };
        
        // å¡«å……åŸå› é€‰æ‹©å™¨
        const categorySelect = document.getElementById('reasonCategory');
        categorySelect.innerHTML = '';
        Object.keys(appState.categories).forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = appState.categories[key].name;
          categorySelect.appendChild(option);
        });
        updateReasonTags();

        document.getElementById('reasonModal').classList.add('show');
        return;
      } else {
        // å–æ¶ˆæ ‡è®°
        delete appState.weekCheckin[day][hour];
      }

      saveData();
      renderCheckinList();
      renderReviewPage();
    }

    function updateReasonTags() {
      const categoryKey = document.getElementById('reasonCategory').value;
      const tagSelect = document.getElementById('reasonTag');
      tagSelect.innerHTML = '';

      const cat = appState.categories[categoryKey];
      cat.tags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagSelect.appendChild(option);
      });
    }

    function saveReason() {
      const { day, hour } = appState.currentEditCell;
      const category = document.getElementById('reasonCategory').value;
      const tag = document.getElementById('reasonTag').value;

      if (!appState.weekCheckin[day]) appState.weekCheckin[day] = {};
      appState.weekCheckin[day][hour] = {
        status: 'undone',
        reason: { category, tag }
      };

      saveData();
      renderCheckinList();
      renderReviewPage();
      closeReasonModal();
    }

    function closeReasonModal() {
      document.getElementById('reasonModal').classList.remove('show');
    }

    // ========== å‘¨å¤ç›˜é¡µé¢ ==========
    function renderReviewPage() {
      renderReviewStats();
      renderCategoryBreakdown();
      renderReviewWeekTable();
    }

    function renderReviewStats() {
      let totalPlanned = 0;
      let totalDone = 0;

      for (let day = 0; day < 7; day++) {
        const plan = appState.weekPlan[day] || {};
        const checkin = appState.weekCheckin[day] || {};

        for (let hour = 7; hour <= 23; hour++) {
          if (plan[hour]) {
            totalPlanned++;
            if (checkin[hour] === 'done') totalDone++;
          }
        }
      }

      const rate = totalPlanned > 0 ? Math.round((totalDone / totalPlanned) * 100) : 0;
      document.getElementById('statCompletion').textContent = `${rate}%`;
      document.getElementById('statTotal').textContent = `${totalDone}/${totalPlanned}`;
    }

    function renderCategoryBreakdown() {
      const container = document.getElementById('categoryBreakdown');
      container.innerHTML = '';

      const stats = {};
      let total = 0;

      // ç»Ÿè®¡å„åˆ†ç±»æ—¶é—´
      for (let day = 0; day < 7; day++) {
        const plan = appState.weekPlan[day] || {};
        const checkin = appState.weekCheckin[day] || {};

        for (let hour = 7; hour <= 23; hour++) {
          const task = plan[hour];
          if (!task) continue;

          const category = checkin[hour] === 'done' ? task.category :
                          (checkin[hour]?.reason ? checkin[hour].reason.category : null);

          if (category) {
            stats[category] = (stats[category] || 0) + 1;
            total++;
          }
        }
      }

      // æ¸²æŸ“æŸ±çŠ¶å›¾
      Object.keys(appState.categories).forEach(key => {
        const cat = appState.categories[key];
        const count = stats[key] || 0;
        const percent = total > 0 ? Math.round((count / total) * 100) : 0;

        const bar = document.createElement('div');
        bar.className = 'category-bar';
        bar.innerHTML = `
          <div class="category-bar-label">
            <span>${cat.name}</span>
            <span>${count}å°æ—¶ (${percent}%)</span>
          </div>
          <div class="category-bar-track">
            <div class="category-bar-fill" style="width: ${percent}%; background: ${cat.color}">
            </div>
          </div>
        `;
        container.appendChild(bar);
      });
    }

    function renderReviewWeekTable() {
      const container = document.getElementById('reviewWeekTable');
      container.innerHTML = '';

      // è¡¨å¤´
      const headers = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
      headers.forEach(h => {
        const cell = document.createElement('div');
        cell.className = 'week-header';
        cell.textContent = h;
        container.appendChild(cell);
      });

      // æ—¶é—´è¡Œ
      for (let hour = 7; hour <= 23; hour++) {
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-label';
        timeLabel.textContent = `${hour}:00`;
        container.appendChild(timeLabel);

        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = 'time-cell';

          const task = appState.weekPlan[day]?.[hour];
          const checkin = appState.weekCheckin[day]?.[hour];

          if (task) {
            if (checkin === 'done') {
              cell.style.background = 'var(--done)';
              cell.textContent = 'âœ“';
            } else if (checkin?.status === 'undone') {
              cell.style.background = 'var(--undone)';
              cell.textContent = 'âœ—';
            } else {
              const cat = appState.categories[task.category];
              cell.style.background = cat.color;
              cell.style.opacity = '0.3';
              cell.textContent = task.tag;
            }
            cell.classList.add('filled');
          }

          container.appendChild(cell);
        }
      }
    }

    // ========== AI åˆ†æ ==========
    function updateAPIProvider() {
      const provider = document.getElementById('apiProvider').value;
      const label = document.getElementById('apiKeyLabel');
      
      if (provider === 'deepseek') {
        label.textContent = 'DeepSeek API Key';
      } else {
        label.textContent = 'æ™ºè°±AI API Key';
      }
    }

    async function analyzeWithAI() {
      const apiKey = appState.apiKey || document.getElementById('apiKey').value;
      if (!apiKey) {
        alert('è¯·å…ˆåœ¨å·¥å…·é¡µé…ç½® API Key');
        switchPage('tools');
        document.querySelectorAll('.nav-item')[3].click();
        return;
      }

      const btn = document.getElementById('aiBtn');
      const btnText = document.getElementById('aiBtnText');
      const result = document.getElementById('aiResult');

      btn.disabled = true;
      btnText.textContent = 'â³ AI æ­£åœ¨æ·±åº¦åˆ†æ...';
      result.classList.remove('show');

      const analysisData = buildDetailedAnalysisData();
      const prompt = buildAnalysisPrompt(analysisData);

      try {
        let response;
        const provider = appState.apiProvider || 'deepseek';

        if (provider === 'deepseek') {
          response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: [
                {
                  role: 'system',
                  content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„äººç”Ÿå¯¼æ¼”å’Œæ—¶é—´ç®¡ç†æ•™ç»ƒ,æ“…é•¿ä»"å‰§æœ¬-æ¼”å‘˜-å¯¼æ¼”"çš„è§†è§’åˆ†æç”¨æˆ·çš„æ—¶é—´ç®¡ç†æ•°æ®ã€‚ä½ çš„åˆ†æè¦æ¸©æš–ã€æœ‰åŠ›é‡ã€æœ‰æ´å¯Ÿ,åƒä¸€ä½æ‡‚æˆ‘çš„å¯¼æ¼”åœ¨ç»™äºˆçœŸè¯šçš„æŒ‡å¯¼ã€‚ä½ çš„åˆ†æè¦æ·±å…¥ã€å…·ä½“ã€æœ‰å¯æ‰§è¡Œæ€§ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.8,
              max_tokens: 2000
            })
          });
        } else {
          // æ™ºè°±API
          response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'glm-4',
              messages: [
                {
                  role: 'system',
                  content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„äººç”Ÿå¯¼æ¼”å’Œæ—¶é—´ç®¡ç†æ•™ç»ƒ,æ“…é•¿ä»"å‰§æœ¬-æ¼”å‘˜-å¯¼æ¼”"çš„è§†è§’åˆ†æç”¨æˆ·çš„æ—¶é—´ç®¡ç†æ•°æ®ã€‚ä½ çš„åˆ†æè¦æ¸©æš–ã€æœ‰åŠ›é‡ã€æœ‰æ´å¯Ÿ,åƒä¸€ä½æ‡‚æˆ‘çš„å¯¼æ¼”åœ¨ç»™äºˆçœŸè¯šçš„æŒ‡å¯¼ã€‚ä½ çš„åˆ†æè¦æ·±å…¥ã€å…·ä½“ã€æœ‰å¯æ‰§è¡Œæ€§ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.8,
              max_tokens: 2000
            })
          });
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `APIè¯·æ±‚å¤±è´¥ (${response.status})`);
        }

        const data = await response.json();
        
        // å¢å¼ºæ–‡æœ¬æ¸…ç†å’Œæ™ºèƒ½æ ¼å¼åŒ–
        let rawText = data.choices[0].message.content
          .replace(/###\s*/g, '')
          .replace(/##\s*/g, '')
          .replace(/#\s*/g, '')
          .replace(/\*\*\*/g, '')
          .replace(/\*\*/g, '')
          .replace(/\*/g, '');
        
        // æ™ºèƒ½æ ¼å¼åŒ–
        const lines = rawText.split('\n').filter(line => line.trim().length > 0);
        let formattedHTML = '<div style="font-weight:600; margin-bottom:10px;">ğŸ¬ å¯¼æ¼”è§†è§’ Â· AI æ´å¯Ÿ</div>';
        
        lines.forEach((line, idx) => {
          line = line.trim();
          
          // æ£€æµ‹é‡ç‚¹æ ‡é¢˜(ä»¥æ•°å­—æˆ–ä¸­æ–‡æ•°å­—å¼€å¤´)
          const pointMatch = line.match(/^([ä¸€äºŒä¸‰å››äº”1-9])[\sã€\.ï¼ï¼š:]\s*(.+)/);
          if (pointMatch) {
            const title = pointMatch[2];
            // åˆ¤æ–­æ˜¯å¦æ˜¯"ä¸‹å‘¨å»ºè®®"æˆ–"æ”¹è¿›å»ºè®®"
            if (title.includes('ä¸‹å‘¨å»ºè®®') || title.includes('æ”¹è¿›å»ºè®®') || title.includes('ä¸‹æœˆ') || title.includes('å»ºè®®')) {
              // ä¸‹å‘¨å»ºè®®/æ”¹è¿›å»ºè®® - åªåŠ ç²—,ä¸åŠ ã€ã€‘
              if (idx > 0) formattedHTML += '<br>';
              formattedHTML += `<div style="font-weight:600; margin:10px 0 5px 0;">${title}</div>`;
            } else {
              // å…¶ä»–é‡ç‚¹ - åŠ ã€ã€‘
              if (idx > 0) formattedHTML += '<br>';
              formattedHTML += `<div style="margin:10px 0 5px 0;">ã€${title}ã€‘</div>`;
            }
          }
          // åˆ—è¡¨é¡¹
          else if (line.startsWith('-')) {
            formattedHTML += `<div style="margin:4px 0;">${line}</div>`;
          }
          // æ™®é€šæ®µè½
          else {
            formattedHTML += `<div style="margin:6px 0;">${line}</div>`;
          }
        });

        result.innerHTML = formattedHTML;
        result.classList.add('show');
        btnText.textContent = 'âœ¨ é‡æ–°åˆ†æ';

      } catch (error) {
        console.error('AIåˆ†æé”™è¯¯:', error);
        alert('AI åˆ†æå¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥:\n1. API Keyæ˜¯å¦æ­£ç¡®\n2. æ˜¯å¦æœ‰ä½™é¢\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
        btnText.textContent = 'âœ¨ AI åˆ†ææœ¬å‘¨æ•°æ®';
      } finally {
        btn.disabled = false;
      }
    }

    function buildAnalysisPrompt(analysisData) {
      return `è¯·æ·±åº¦åˆ†ææˆ‘æœ¬å‘¨çš„"äººç”Ÿå‰§æœ¬"æ‰§è¡Œæƒ…å†µ:

ã€çŸ¥è¡Œåˆä¸€æƒ…å†µã€‘
- è®¡åˆ’å®Œæˆç‡: ${analysisData.completionRate}%
- è®¡åˆ’æ—¶æ®µ: ${analysisData.totalPlanned}å°æ—¶
- å®é™…å®Œæˆ: ${analysisData.totalDone}å°æ—¶
- æœªå®Œæˆ: ${analysisData.totalUndone}å°æ—¶

ã€æ—¶é—´å®é™…åˆ†å¸ƒã€‘(æˆ‘å®é™…åšäº†ä»€ä¹ˆ)
${Object.keys(analysisData.actualDistribution).map(key => {
  const cat = appState.categories[key];
  const hours = analysisData.actualDistribution[key];
  const percent = analysisData.actualTotal > 0 ? Math.round(hours/analysisData.actualTotal*100) : 0;
  return `- ${cat.name}: ${hours}å°æ—¶ (${percent}%)`;
}).join('\n')}

ã€è®¡åˆ’vså®é™…å¯¹æ¯”ã€‘(è®¡åˆ’ä¸ç°å®çš„å·®è·)
${Object.keys(appState.categories).map(key => {
  const cat = appState.categories[key];
  const planned = analysisData.plannedDistribution[key] || 0;
  const actual = analysisData.actualDistribution[key] || 0;
  if (planned === 0 && actual === 0) return '';
  const diff = actual - planned;
  const sign = diff > 0 ? '+' : '';
  return `- ${cat.name}: è®¡åˆ’${planned}h â†’ å®é™…${actual}h (${sign}${diff}h)`;
}).filter(Boolean).join('\n')}

ã€æœªå®ŒæˆåŸå› åˆ†æã€‘(å“ªäº›è®¡åˆ’è¢«ä»€ä¹ˆæ›¿ä»£äº†)
${analysisData.undoneReasons.length > 0 ? 
  analysisData.undoneReasons.slice(0, 3).map(r => `- åŸè®¡åˆ’${r.planned},å®é™…åšäº†${r.actual}`).join('\n') : 
  'æœ¬å‘¨å…¨éƒ¨æŒ‰è®¡åˆ’æ‰§è¡Œ,çŸ¥è¡Œåˆä¸€ âœ“'}

ã€å¯¼æ¼”å¤ç›˜ç¬”è®°ã€‘(æˆ‘è‡ªå·±çš„æ€è€ƒ)
é«˜å…‰æ—¶åˆ»: ${appState.reviewNotes.highlight || 'æœªå¡«å†™'}
ç©¿å¸®é•œå¤´: ${appState.reviewNotes.ng || 'æœªå¡«å†™'}
å¯¼æ¼”æ€è€ƒ: ${appState.reviewNotes.thinking || 'æœªå¡«å†™'}

---

è¯·ä½ ä½œä¸ºä¸€ä½ä¸“ä¸šçš„"äººç”Ÿå¯¼æ¼”"å’Œæ—¶é—´ç®¡ç†æ•™ç»ƒ,ä»å¯¼æ¼”å¤ç›˜çš„è§’åº¦ç»™å‡ºæ·±åº¦åˆ†æã€‚

å¿…é¡»åŒ…å«ä»¥ä¸‹5ä¸ªéƒ¨åˆ†(æ¯éƒ¨åˆ†éƒ½è¦å……åˆ†å±•å¼€,ä¸èƒ½çœç•¥):

1. **ã€å‰§æœ¬æ€»ç»“ã€‘** ç”¨ä¸€å¥å¹½é»˜ã€æœ‰æ´å¯ŸåŠ›çš„è¯æ¦‚æ‹¬æœ¬å‘¨çš„æ—¶é—´åˆ†é…ç‰¹ç‚¹
   - ä¾‹å¦‚:"ä½ å¯çœŸæ˜¯ä¸ªåœ¨æ•°å­—ä¸–ç•Œé‡ŒæŠ«æ˜Ÿæˆ´æœˆçš„åˆ›ä½œè€…"
   - ä¾‹å¦‚:"ä¸€ä½åœ¨æ¢ç´¢ä¸­è¿·è·¯çš„åˆ›ä½œè€…â€”â€”è®¡åˆ’å®å¤§,ä½†å®é™…æ‰§è¡Œæ—¶å´åç¦»äº†å‰§æœ¬"
   - è¦æœ‰ä¸ªæ€§,è¦å‡†ç¡®åæ˜ æ•°æ®ç‰¹å¾

2. **ã€çŸ¥è¡Œåˆä¸€ã€‘** æ·±åº¦åˆ†æè®¡åˆ’å®Œæˆç‡${analysisData.completionRate}%çš„å«ä¹‰
   - è¿™ä¸ªå®Œæˆç‡è¯´æ˜äº†ä»€ä¹ˆ?
   - è®¡åˆ’åˆ¶å®šæ˜¯å¦åˆç†?
   - æ‰§è¡ŒåŠ›å¦‚ä½•?
   - å“ªäº›ç±»å‹çš„æ—¶é—´å®¹æ˜“æ‰§è¡Œ,å“ªäº›å®¹æ˜“è¢«å¿½ç•¥?

3. **ã€æ—¶é—´åˆ†é…ã€‘** æ·±å…¥åˆ†ææ—¶é—´åˆ†å¸ƒæ˜¯å¦ç¬¦åˆç†æƒ³äººç”Ÿå‰§æœ¬
   - å·¥ä½œæ—¶é—´${analysisData.actualDistribution.work || 0}hå æ¯”${analysisData.actualTotal > 0 ? Math.round((analysisData.actualDistribution.work || 0)/analysisData.actualTotal*100) : 0}%,æ˜¯å¦è¿‡å¤š/è¿‡å°‘?
   - è‡ªæˆ‘æˆé•¿ã€å¥åº·ã€å®¶åº­çš„æ—¶é—´æ˜¯å¦å‡è¡¡?
   - æ—¶é—´åˆ†é…åæ˜ å‡ºä»€ä¹ˆæ ·çš„ç”Ÿæ´»çŠ¶æ€å’Œä»·å€¼è§‚?

4. **ã€ç©¿å¸®åˆ†æã€‘** ç»“åˆç”¨æˆ·çš„å¤ç›˜ç¬”è®°,ç»™å‡ºçœŸè¯šçš„åé¦ˆ
   - é«˜å…‰æ—¶åˆ»å€¼å¾—è‚¯å®šçš„åœ°æ–¹
   - ç©¿å¸®é•œå¤´èƒŒåçš„æ·±å±‚åŸå› 
   - å¯¼æ¼”æ€è€ƒæ˜¯å¦åˆ‡ä¸­è¦å®³

5. **ã€ä¸‹å‘¨å»ºè®®ã€‘** 3æ¡å…·ä½“å¯æ‰§è¡Œçš„ä¼˜åŒ–å»ºè®®
   - é’ˆå¯¹æ•°æ®ä¸­å‘ç°çš„é—®é¢˜
   - ç»“åˆç”¨æˆ·çš„å¤ç›˜æ€è€ƒ
   - è¦å…·ä½“,è¦å¯æ‰§è¡Œ

è¦æ±‚:
- æ€»å­—æ•°300-400å­—,æ¯ä¸ªéƒ¨åˆ†éƒ½è¦å……åˆ†å±•å¼€
- è¯­è¨€è¦æ¸©æš–ã€çœŸè¯šã€æœ‰åŠ›é‡,åƒä¸€ä½æ‡‚æˆ‘çš„å¯¼æ¼”åœ¨ç»™æˆ‘æŒ‡å¯¼
- è¦åŸºäºæ•°æ®è¯´è¯,ä¸è¦ç©ºæ´çš„é¼“åŠ±
- è¦æœ‰æ´å¯Ÿ,è¦ç‚¹å‡ºé—®é¢˜,ä½†ä¹Ÿè¦ç»™å‡ºå¸Œæœ›`;
    }

    function buildDetailedAnalysisData() {
      let totalPlanned = 0;
      let totalDone = 0;
      let totalUndone = 0;
      let actualTotal = 0;
      
      const plannedDistribution = {};
      const actualDistribution = {};
      const undoneReasons = [];

      for (let day = 0; day < 7; day++) {
        const plan = appState.weekPlan[day] || {};
        const checkin = appState.weekCheckin[day] || {};

        for (let hour = 7; hour <= 23; hour++) {
          const task = plan[hour];
          if (!task) continue;

          totalPlanned++;
          plannedDistribution[task.category] = (plannedDistribution[task.category] || 0) + 1;

          const checkinStatus = checkin[hour];
          
          if (checkinStatus === 'done') {
            totalDone++;
            actualDistribution[task.category] = (actualDistribution[task.category] || 0) + 1;
            actualTotal++;
          } else if (checkinStatus?.status === 'undone' && checkinStatus.reason) {
            totalUndone++;
            const reasonCat = checkinStatus.reason.category;
            actualDistribution[reasonCat] = (actualDistribution[reasonCat] || 0) + 1;
            actualTotal++;
            
            undoneReasons.push({
              planned: `${appState.categories[task.category].name}-${task.tag}`,
              actual: `${appState.categories[reasonCat].name}-${checkinStatus.reason.tag}`
            });
          }
        }
      }

      return {
        totalPlanned,
        totalDone,
        totalUndone,
        actualTotal,
        completionRate: totalPlanned > 0 ? Math.round((totalDone / totalPlanned) * 100) : 0,
        plannedDistribution,
        actualDistribution,
        undoneReasons
      };
    }

    function saveAPIKey() {
      appState.apiKey = document.getElementById('apiKey').value;
      appState.apiProvider = document.getElementById('apiProvider').value;
      saveData();
      alert('APIé…ç½®å·²ä¿å­˜');
    }

    // ========== åˆ†äº«åŠŸèƒ½ ==========
    // 1. åˆ†äº«å‘¨è®¡åˆ’è¡¨æ ¼
    async function shareWeekPlan() {
      const canvas = await captureWeekTable('plan');
      downloadCanvas(canvas, 'æœ¬å‘¨å‰§æœ¬');
    }

    // 2. åˆ†äº«æ‰§è¡Œæƒ…å†µè¡¨æ ¼
    async function shareWeekReview() {
      // ä½¿ç”¨å’ŒshareWeekReviewPageç›¸åŒçš„ç²¾ç®€ç‰ˆå¡ç‰‡
      await shareWeekReviewPage();
    }

    // 3. åˆ†äº«AIæ´å¯Ÿ
    async function shareAIInsight() {
      const aiResult = document.getElementById('aiResult');
      if (!aiResult.classList.contains('show')) {
        alert('è¯·å…ˆè¿›è¡ŒAIåˆ†æ');
        return;
      }

      const shareCard = createAIShareCard();
      const canvas = await html2canvas(shareCard, {
        backgroundColor: '#6C5CE7',
        scale: 2,
        logging: false
      });
      
      document.body.removeChild(shareCard);
      downloadCanvas(canvas, 'AIæ´å¯Ÿ');
    }

    // 4. åˆ†äº«æ•°æ®å¡ç‰‡
    async function shareStatCard() {
      const card = createStatShareCard();
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        backgroundColor: '#667eea',
        allowTaint: true,
        useCORS: true
      });
      
      document.body.removeChild(card);
      downloadCanvas(canvas, 'æœ¬å‘¨æ•°æ®');
    }

    // 5. ç»„åˆåˆ†äº« - ç”¨æˆ·å¯å¤šé€‰æ¨¡å—
    async function shareCustomCard() {
      const opt1 = document.getElementById('shareOpt1')?.checked; // å‘¨åº¦å®¡è§†
      const opt2 = document.getElementById('shareOpt2')?.checked; // æ—¶é—´åˆ†å¸ƒ
      const opt3 = document.getElementById('shareOpt3')?.checked; // å¤ç›˜ç¬”è®°
      
      if (!opt1 && !opt2 && !opt3) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å—');
        return;
      }
      
      try {
        const card = createCustomShareCard(opt1, opt2, opt3);
        const canvas = await html2canvas(card, {
          scale: 2,
          logging: false,
          backgroundColor: '#667eea',
          allowTaint: true,
          useCORS: true
        });
        
        document.body.removeChild(card);
        downloadCanvas(canvas, 'å¯¼æ¼”æ€»ç»“');
      } catch(e) {
        console.error('ç»„åˆåˆ†äº«å¤±è´¥:', e);
        alert('ç”Ÿæˆåˆ†äº«å›¾å¤±è´¥,è¯·æŸ¥çœ‹æ§åˆ¶å°');
      }
    }
    
    // åˆ›å»ºç»„åˆåˆ†äº«å¡ç‰‡
    function createCustomShareCard(showStats, showDistribution, showNotes) {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px; color:white; font-family: "Noto Sans SC", sans-serif;';

      // æ ‡é¢˜
      const title = document.createElement('div');
      title.style.cssText = 'font-size:28px; font-weight:700; margin-bottom:20px; font-family: "Noto Serif SC", serif;';
      title.textContent = `${appState.userName} çš„äººç”Ÿå‰§æœ¬`;
      card.appendChild(title);

      // å‘¨ä¿¡æ¯
      const weekInfo = document.createElement('div');
      weekInfo.style.cssText = 'font-size:14px; opacity:0.9; margin-bottom:30px;';
      const now = new Date();
      const weekNum = getWeekNumber(now);
      weekInfo.textContent = `2026å¹´ ç¬¬${weekNum}å‘¨`;
      card.appendChild(weekInfo);

      const analysisData = buildDetailedAnalysisData(); // ä½¿ç”¨æ­£ç¡®çš„å‡½æ•°å

      // æ¨¡å—1: å‘¨åº¦å®¡è§†
      if (showStats) {
        const statsBox = document.createElement('div');
        statsBox.style.cssText = 'background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); padding:25px; margin-bottom:20px;';
        
        const statsGrid = document.createElement('div');
        statsGrid.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:25px; margin-bottom:20px;';
        
        // è·å–è¯„çº§ä¿¡æ¯
        const rating = getRatingInfo(analysisData.completionRate);
        
        statsGrid.innerHTML = `
          <div style="text-align:center;">
            <div style="font-size:48px; font-weight:700; margin-bottom:10px;">${analysisData.completionRate}%</div>
            <div style="font-size:14px; opacity:0.9; margin-bottom:8px;">çŸ¥è¡Œåˆä¸€ç‡</div>
            <div style="display:inline-block; background:${rating.color}20; color:${rating.color}; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">
              ${rating.icon} ${rating.level}
            </div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:48px; font-weight:700; margin-bottom:10px;">${analysisData.totalDone}/${analysisData.totalPlanned}</div>
            <div style="font-size:14px; opacity:0.9;">å®Œæˆæ—¶æ®µ</div>
          </div>
        `;
        statsBox.appendChild(statsGrid);
        
        // æ·»åŠ è¯„çº§è¯´æ˜å’Œç†æƒ³åŒºé—´æç¤º
        const ratingInfo = document.createElement('div');
        ratingInfo.style.cssText = `
          background:${rating.inIdealRange ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255,255,255,0.1)'};
          padding:15px;
          border-radius:10px;
          font-size:13px;
          line-height:1.6;
          ${rating.inIdealRange ? 'border:2px solid rgba(76, 175, 80, 0.3);' : ''}
        `;
        
        if (rating.inIdealRange) {
          ratingInfo.innerHTML = `
            <div style="font-weight:600; margin-bottom:8px; color:#4CAF50;">âœ“ åœ¨ç†æƒ³åŒºé—´å†… (75-85%)</div>
            <div>${rating.encouragement}</div>
          `;
        } else {
          ratingInfo.innerHTML = `
            <div style="font-weight:600; margin-bottom:8px;">${rating.message}</div>
            <div style="opacity:0.9;">${rating.encouragement}</div>
            <div style="margin-top:10px; font-size:12px; opacity:0.7;">
              ğŸ’¡ ç†æƒ³åŒºé—´: 75-85% Â· æ—¢æœ‰æŒ‘æˆ˜æ€§åˆåˆ‡å®å¯è¡Œ
            </div>
          `;
        }
        
        statsBox.appendChild(ratingInfo);
        card.appendChild(statsBox);
      }

      // æ¨¡å—2: æ—¶é—´åˆ†å¸ƒ
      if (showDistribution) {
        const distBox = document.createElement('div');
        distBox.style.cssText = 'background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); padding:25px; margin-bottom:20px;';
        
        const distTitle = document.createElement('div');
        distTitle.style.cssText = 'font-size:16px; font-weight:600; margin-bottom:15px; opacity:0.9;';
        distTitle.innerHTML = 'â° æ—¶é—´åˆ†å¸ƒ';
        distBox.appendChild(distTitle);
        
        Object.keys(analysisData.actualDistribution).forEach(key => {
          const cat = appState.categories[key];
          const hours = analysisData.actualDistribution[key];
          const percent = analysisData.actualTotal > 0 ? Math.round((hours / analysisData.actualTotal) * 100) : 0;
          
          const row = document.createElement('div');
          row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:14px;';
          row.innerHTML = `
            <span>${cat.name}</span>
            <span style="font-weight:600;">${hours}å°æ—¶ (${percent}%)</span>
          `;
          distBox.appendChild(row);
        });
        card.appendChild(distBox);
      }

      // æ¨¡å—3: å¤ç›˜ç¬”è®°
      if (showNotes) {
        const notesBox = document.createElement('div');
        notesBox.style.cssText = 'background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); padding:25px; margin-bottom:20px;';
        
        let hasContent = false;
        
        if (appState.reviewNotes.highlight) {
          const h = document.createElement('div');
          h.style.cssText = 'margin-bottom:15px;';
          h.innerHTML = `<div style="font-size:14px; font-weight:600; margin-bottom:8px; opacity:0.9;">ğŸŒŸ é«˜å…‰æ—¶åˆ»</div><div style="font-size:13px; line-height:1.7; opacity:0.95;">${appState.reviewNotes.highlight}</div>`;
          notesBox.appendChild(h);
          hasContent = true;
        }
        
        if (appState.reviewNotes.ng) {
          const ng = document.createElement('div');
          ng.style.cssText = 'margin-bottom:15px;';
          ng.innerHTML = `<div style="font-size:14px; font-weight:600; margin-bottom:8px; opacity:0.9;">ğŸ’£ ç©¿å¸®é•œå¤´</div><div style="font-size:13px; line-height:1.7; opacity:0.95;">${appState.reviewNotes.ng}</div>`;
          notesBox.appendChild(ng);
          hasContent = true;
        }
        
        if (appState.reviewNotes.thinking) {
          const t = document.createElement('div');
          t.innerHTML = `<div style="font-size:14px; font-weight:600; margin-bottom:8px; opacity:0.9;">ğŸ’¡ å¯¼æ¼”æ€è€ƒ</div><div style="font-size:13px; line-height:1.7; opacity:0.95;">${appState.reviewNotes.thinking}</div>`;
          notesBox.appendChild(t);
          hasContent = true;
        }
        
        if (hasContent) {
          card.appendChild(notesBox);
        }
      }

      // åº•éƒ¨æ°´å°
      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; opacity:0.6; margin-top:20px;';
      watermark.innerHTML = `${appState.userName}çš„äººç”Ÿå‰§æœ¬<br>æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // 6. åˆ†äº«å‘¨åº¦å®¡è§†é¡µé¢ (ç™½è‰²å¡ç‰‡é£æ ¼) - ç²¾ç®€ç‰ˆ
    async function shareWeekReviewPage() {
      const card = createCompactWeekReviewCard();
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        backgroundColor: '#ffffff',
        allowTaint: true,
        useCORS: true
      });
      
      document.body.removeChild(card);
      downloadCanvas(canvas, 'å‘¨åº¦å®¡è§†');
    }

    // åˆ›å»ºç²¾ç®€ç‰ˆå‘¨åº¦å®¡è§†åˆ†äº«å¡ç‰‡(åªåŒ…å«:ç»Ÿè®¡+åˆ†å¸ƒ+æ‰§è¡Œè¡¨æ ¼)
    function createCompactWeekReviewCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:white; padding:40px; font-family: "Noto Sans SC", sans-serif;';

      // æ ‡é¢˜åŒº
      const header = document.createElement('div');
      header.style.cssText = 'margin-bottom:30px;';
      
      const title = document.createElement('div');
      title.style.cssText = 'font-size:24px; font-weight:700; color:#2C2C2C; margin-bottom:10px;';
      title.textContent = 'ğŸ“Š å‘¨åº¦å®¡è§†';
      header.appendChild(title);
      
      const subtitle = document.createElement('div');
      subtitle.style.cssText = 'font-size:14px; color:#8B8B8B;';
      const now = new Date();
      const weekNum = getWeekNumber(now);
      subtitle.textContent = `${appState.userName} Â· 2026å¹´ç¬¬${weekNum}å‘¨`;
      header.appendChild(subtitle);
      
      card.appendChild(header);

      const analysisData = buildDetailedAnalysisData();
      
      // è·å–è¯„çº§ä¿¡æ¯
      const rating = getRatingInfo(analysisData.completionRate);

      // 1. ç»Ÿè®¡å¡ç‰‡ + è¯„çº§
      const statsGrid = document.createElement('div');
      statsGrid.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;';
      
      statsGrid.innerHTML = `
        <div style="background:#f9f9f9; border-radius:12px; padding:25px; text-align:center;">
          <div style="font-size:42px; font-weight:700; color:#2C2C2C; margin-bottom:8px;">${analysisData.completionRate}%</div>
          <div style="font-size:13px; color:#8B8B8B; margin-bottom:8px;">çŸ¥è¡Œåˆä¸€ç‡</div>
          <div style="display:inline-block; background:${rating.color}20; color:${rating.color}; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">
            ${rating.icon} ${rating.level}
          </div>
        </div>
        <div style="background:#f9f9f9; border-radius:12px; padding:25px; text-align:center;">
          <div style="font-size:42px; font-weight:700; color:#2C2C2C; margin-bottom:8px;">${analysisData.totalDone}/${analysisData.totalPlanned}</div>
          <div style="font-size:13px; color:#8B8B8B;">å®Œæˆæ—¶æ®µ</div>
        </div>
      `;
      card.appendChild(statsGrid);
      
      // è¯„çº§è¯´æ˜(åªåœ¨ç†æƒ³åŒºé—´å¤–æ˜¾ç¤º)
      if (!rating.inIdealRange) {
        const ratingTip = document.createElement('div');
        ratingTip.style.cssText = 'background:#f9f9f9; border-radius:8px; padding:12px; margin-bottom:25px; font-size:12px; color:#666; text-align:center;';
        ratingTip.innerHTML = `ğŸ’¡ ç†æƒ³åŒºé—´: 75-85% Â· æ—¢æœ‰æŒ‘æˆ˜æ€§åˆåˆ‡å®å¯è¡Œ`;
        card.appendChild(ratingTip);
      } else {
        const ratingTip = document.createElement('div');
        ratingTip.style.cssText = 'background:#E8F5E9; border-radius:8px; padding:12px; margin-bottom:25px; font-size:12px; color:#4CAF50; text-align:center; font-weight:600;';
        ratingTip.innerHTML = `âœ“ åœ¨ç†æƒ³åŒºé—´å†…!ç»§ç»­ä¿æŒ`;
        card.appendChild(ratingTip);
      }

      // 2. æ—¶é—´åˆ†å¸ƒ
      const distBox = document.createElement('div');
      distBox.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:20px; margin-bottom:25px;';
      
      const distTitle = document.createElement('div');
      distTitle.style.cssText = 'font-size:15px; font-weight:600; margin-bottom:15px; color:#2C2C2C; display:flex; align-items:center; gap:6px;';
      distTitle.innerHTML = 'â° æ—¶é—´åˆ†å¸ƒ';
      distBox.appendChild(distTitle);
      
      Object.keys(analysisData.actualDistribution).forEach(key => {
        const cat = appState.categories[key];
        const hours = analysisData.actualDistribution[key];
        const percent = analysisData.actualTotal > 0 ? Math.round((hours / analysisData.actualTotal) * 100) : 0;
        
        const row = document.createElement('div');
        row.style.cssText = 'margin-bottom:12px;';
        
        const label = document.createElement('div');
        label.style.cssText = 'display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#2C2C2C;';
        label.innerHTML = `<span>${cat.name}</span><span style="font-weight:600;">${hours}å°æ—¶ (${percent}%)</span>`;
        
        const track = document.createElement('div');
        track.style.cssText = 'height:8px; background:#e5e5e5; border-radius:4px; overflow:hidden;';
        
        const fill = document.createElement('div');
        fill.style.cssText = `width:${percent}%; height:100%; background:${cat.color}; border-radius:4px;`;
        
        track.appendChild(fill);
        row.appendChild(label);
        row.appendChild(track);
        distBox.appendChild(row);
      });
      
      card.appendChild(distBox);

      // 3. æœ¬å‘¨æ‰§è¡Œæƒ…å†µ(ç®€åŒ–è¡¨æ ¼)
      const tableBox = document.createElement('div');
      tableBox.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:20px;';
      
      const tableTitle = document.createElement('div');
      tableTitle.style.cssText = 'font-size:15px; font-weight:600; margin-bottom:15px; color:#2C2C2C;';
      tableTitle.textContent = 'ğŸ“… æœ¬å‘¨æ‰§è¡Œæƒ…å†µ';
      tableBox.appendChild(tableTitle);
      
      // åˆ›å»ºç®€åŒ–çš„è¡¨æ ¼
      const table = document.createElement('div');
      table.style.cssText = 'font-size:11px;';
      
      // è¡¨å¤´
      const thead = document.createElement('div');
      thead.style.cssText = 'display:grid; grid-template-columns: 40px repeat(7, 1fr); gap:2px; margin-bottom:4px; font-weight:600; color:#666;';
      thead.innerHTML = `
        <div style="text-align:center; padding:4px;">æ—¶æ®µ</div>
        <div style="text-align:center; padding:4px;">å‘¨ä¸€</div>
        <div style="text-align:center; padding:4px;">å‘¨äºŒ</div>
        <div style="text-align:center; padding:4px;">å‘¨ä¸‰</div>
        <div style="text-align:center; padding:4px;">å‘¨å››</div>
        <div style="text-align:center; padding:4px;">å‘¨äº”</div>
        <div style="text-align:center; padding:4px;">å‘¨å…­</div>
        <div style="text-align:center; padding:4px;">å‘¨æ—¥</div>
      `;
      table.appendChild(thead);
      
      // è¡¨èº«(åªæ˜¾ç¤ºæœ‰è®¡åˆ’çš„æ—¶æ®µ)
      for (let hour = 7; hour <= 23; hour++) {
        let hasData = false;
        for (let day = 0; day < 7; day++) {
          if (appState.weekPlan[day]?.[hour]) {
            hasData = true;
            break;
          }
        }
        
        if (!hasData) continue; // è·³è¿‡æ— æ•°æ®çš„æ—¶æ®µ
        
        const row = document.createElement('div');
        row.style.cssText = 'display:grid; grid-template-columns: 40px repeat(7, 1fr); gap:2px; margin-bottom:2px;';
        
        row.innerHTML = `<div style="text-align:center; padding:4px; font-size:10px; color:#999;">${hour}:00</div>`;
        
        for (let day = 0; day < 7; day++) {
          const task = appState.weekPlan[day]?.[hour];
          const checkin = appState.weekCheckin[day]?.[hour];
          
          let cellStyle = 'text-align:center; padding:4px; border-radius:4px; ';
          let cellContent = '';
          
          if (!task) {
            cellStyle += 'background:#f5f5f5;';
          } else if (checkin === 'done') {
            cellStyle += 'background:#4CAF50; color:white;';
            cellContent = 'âœ“';
          } else if (checkin?.reason) {
            cellStyle += 'background:#FF9800; color:white;';
            cellContent = 'â—‹';
          } else {
            cellStyle += 'background:#e0e0e0;';
          }
          
          row.innerHTML += `<div style="${cellStyle}">${cellContent}</div>`;
        }
        
        table.appendChild(row);
      }
      
      tableBox.appendChild(table);
      card.appendChild(tableBox);

      // åº•éƒ¨æ°´å°
      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; color:#999; margin-top:25px; padding-top:20px; border-top:1px solid #e5e5e5;';
      watermark.textContent = `${appState.userName}çš„äººç”Ÿå‰§æœ¬ Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // 7. åˆ†äº«æœˆåº¦å®¡è§†é¡µé¢
    async function shareMonthReviewPage() {
      const card = createMonthReviewCard();
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        backgroundColor: '#ffffff'
      });
      
      document.body.removeChild(card);
      downloadCanvas(canvas, 'æœˆåº¦å®¡è§†');
    }

    // åˆ›å»ºæœˆåº¦å®¡è§†åˆ†äº«å¡ç‰‡ (ç±»ä¼¼å‘¨åº¦é£æ ¼)
    function createMonthReviewCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:white; padding:40px; font-family: "Noto Sans SC", sans-serif;';

      // æ ‡é¢˜
      const header = document.createElement('div');
      header.style.cssText = 'margin-bottom:30px;';
      
      const title = document.createElement('div');
      title.style.cssText = 'font-size:24px; font-weight:700; color:#2C2C2C; margin-bottom:10px;';
      title.textContent = 'ğŸ“… æœˆåº¦å®¡è§†';
      header.appendChild(title);
      
      const subtitle = document.createElement('div');
      subtitle.style.cssText = 'font-size:14px; color:#8B8B8B;';
      const now = new Date();
      subtitle.textContent = `${appState.userName} Â· ${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
      header.appendChild(subtitle);
      
      card.appendChild(header);

      const monthData = getMonthData();
      
      // è·å–è¯„çº§ä¿¡æ¯
      const rating = getRatingInfo(monthData.completionRate);

      // ç»Ÿè®¡å¡ç‰‡ + è¯„çº§
      const statsGrid = document.createElement('div');
      statsGrid.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;';
      
      statsGrid.innerHTML = `
        <div style="background:#f9f9f9; border-radius:12px; padding:25px; text-align:center;">
          <div style="font-size:42px; font-weight:700; color:#2C2C2C; margin-bottom:8px;">${monthData.completionRate}%</div>
          <div style="font-size:13px; color:#8B8B8B; margin-bottom:8px;">æœˆåº¦çŸ¥è¡Œåˆä¸€ç‡</div>
          <div style="display:inline-block; background:${rating.color}20; color:${rating.color}; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">
            ${rating.icon} ${rating.level}
          </div>
        </div>
        <div style="background:#f9f9f9; border-radius:12px; padding:25px; text-align:center;">
          <div style="font-size:42px; font-weight:700; color:#2C2C2C; margin-bottom:8px;">${monthData.totalDone}/${monthData.totalPlanned}</div>
          <div style="font-size:13px; color:#8B8B8B;">å®Œæˆæ—¶æ®µ</div>
        </div>
      `;
      card.appendChild(statsGrid);
      
      // è¯„çº§è¯´æ˜
      if (!rating.inIdealRange) {
        const ratingTip = document.createElement('div');
        ratingTip.style.cssText = 'background:#f9f9f9; border-radius:8px; padding:12px; margin-bottom:25px; font-size:12px; color:#666; text-align:center;';
        ratingTip.innerHTML = `ğŸ’¡ ç†æƒ³åŒºé—´: 75-85% Â· æ—¢æœ‰æŒ‘æˆ˜æ€§åˆåˆ‡å®å¯è¡Œ`;
        card.appendChild(ratingTip);
      } else {
        const ratingTip = document.createElement('div');
        ratingTip.style.cssText = 'background:#E8F5E9; border-radius:8px; padding:12px; margin-bottom:25px; font-size:12px; color:#4CAF50; text-align:center; font-weight:600;';
        ratingTip.innerHTML = `âœ“ åœ¨ç†æƒ³åŒºé—´å†…!ç»§ç»­ä¿æŒ`;
        card.appendChild(ratingTip);
      }

      // å‘¨åº¦è¶‹åŠ¿
      if (monthData.weeklyStats.length > 0) {
        const trendBox = document.createElement('div');
        trendBox.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:20px; margin-bottom:25px;';
        
        const trendTitle = document.createElement('div');
        trendTitle.style.cssText = 'font-size:15px; font-weight:600; margin-bottom:15px; color:#2C2C2C;';
        trendTitle.textContent = 'ğŸ“ˆ å‘¨åº¦è¶‹åŠ¿';
        trendBox.appendChild(trendTitle);
        
        monthData.weeklyStats.forEach((stat, idx) => {
          const bar = document.createElement('div');
          bar.style.cssText = 'margin-bottom:12px;';
          
          const label = document.createElement('div');
          label.style.cssText = 'display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#2C2C2C;';
          label.innerHTML = `<span>ç¬¬${idx + 1}å‘¨</span><span style="font-weight:600;">${stat.rate}%</span>`;
          
          const track = document.createElement('div');
          track.style.cssText = 'height:10px; background:#e5e5e5; border-radius:5px; overflow:hidden;';
          
          const fill = document.createElement('div');
          fill.style.cssText = `width:${stat.rate}%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2);`;
          
          track.appendChild(fill);
          bar.appendChild(label);
          bar.appendChild(track);
          trendBox.appendChild(bar);
        });
        
        card.appendChild(trendBox);
      }

      // æ—¶é—´åˆ†å¸ƒ
      if (Object.keys(monthData.categoryDistribution).length > 0) {
        const distBox = document.createElement('div');
        distBox.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:20px; margin-bottom:25px;';
        
        const distTitle = document.createElement('div');
        distTitle.style.cssText = 'font-size:15px; font-weight:600; margin-bottom:15px; color:#2C2C2C;';
        distTitle.textContent = 'â° æ—¶é—´åˆ†å¸ƒ';
        distBox.appendChild(distTitle);
        
        Object.keys(monthData.categoryDistribution).forEach(key => {
          const cat = appState.categories[key];
          const hours = monthData.categoryDistribution[key];
          const percent = monthData.totalDone > 0 ? Math.round((hours / monthData.totalDone) * 100) : 0;
          
          const row = document.createElement('div');
          row.style.cssText = 'margin-bottom:12px;';
          
          const label = document.createElement('div');
          label.style.cssText = 'display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#2C2C2C;';
          label.innerHTML = `<span>${cat.name}</span><span style="font-weight:600;">${hours}å°æ—¶ (${percent}%)</span>`;
          
          const track = document.createElement('div');
          track.style.cssText = 'height:8px; background:#e5e5e5; border-radius:4px; overflow:hidden;';
          
          const fill = document.createElement('div');
          fill.style.cssText = `width:${percent}%; height:100%; background:${cat.color}; border-radius:4px;`;
          
          track.appendChild(fill);
          row.appendChild(label);
          row.appendChild(track);
          distBox.appendChild(row);
        });
        
        card.appendChild(distBox);
      }

      // æœ¬æœˆæ‰§è¡Œæƒ…å†µ(æŒ‰å¤©æ˜¾ç¤º,ä¿®å¤ç‰ˆ)
      const execBox = document.createElement('div');
      execBox.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:20px; margin-bottom:25px;';
      
      const execTitle = document.createElement('div');
      execTitle.style.cssText = 'font-size:15px; font-weight:600; margin-bottom:15px; color:#2C2C2C;';
      execTitle.textContent = 'ğŸ“… æœ¬æœˆæ‰§è¡Œæƒ…å†µ';
      execBox.appendChild(execTitle);
      
      // è·å–æœ¬æœˆå¤©æ•°
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const daysInMonth = new Date(year, month, 0).getDate();
      const today = now.getDate();
      
      // æ”¶é›†æœ¬æœˆæ¯å¤©çš„æ•°æ®
      const dailyData = [];
      
      // è·å–æ‰€æœ‰æœ¬æœˆçš„å‘¨æ•°æ®
      const weekKeys = Object.keys(appState.weeklyData)
        .filter(key => !key.includes('notes'))
        .sort();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month - 1, day);
        const dayOfWeek = dayDate.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€...
        const actualDayOfWeek = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; // è½¬æ¢ä¸º0=å‘¨ä¸€
        
        let dayPlanned = 0;
        let dayDone = 0;
        let found = false;
        
        // éå†æ‰€æœ‰å‘¨æ•°æ®,æ‰¾åˆ°åŒ…å«è¿™ä¸€å¤©çš„å‘¨
        for (const weekKey of weekKeys) {
          const weekData = appState.weeklyData[weekKey];
          if (!weekData || !weekData.plan) continue;
          
          const plan = weekData.plan;
          const checkin = weekData.checkin || {};
          
          // æ£€æŸ¥è¿™ä¸€å‘¨çš„è¿™ä¸€å¤©æ˜¯å¦æœ‰æ•°æ®
          if (plan[actualDayOfWeek]) {
            // è®¡ç®—è¿™ä¸€å¤©çš„çŸ¥è¡Œåˆä¸€ç‡
            for (let hour = 7; hour <= 23; hour++) {
              if (plan[actualDayOfWeek][hour]) {
                dayPlanned++;
                const status = checkin[actualDayOfWeek]?.[hour];
                if (status === 'done' || status?.reason) {
                  dayDone++;
                }
              }
            }
            
            if (dayPlanned > 0) {
              found = true;
              break; // æ‰¾åˆ°æ•°æ®å°±åœæ­¢
            }
          }
        }
        
        const rate = dayPlanned > 0 ? Math.round((dayDone / dayPlanned) * 100) : 0;
        dailyData.push({ day, rate, hasData: found && dayPlanned > 0 });
      }
      
      // åˆ›å»ºæ—¥å†ç½‘æ ¼
      const calendar = document.createElement('div');
      calendar.style.cssText = 'display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;';
      
      // æ˜ŸæœŸæ ‡é¢˜
      const weekDays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
      weekDays.forEach(day => {
        const header = document.createElement('div');
        header.style.cssText = 'text-align:center; font-size:11px; color:#999; padding:5px; font-weight:600;';
        header.textContent = day;
        calendar.appendChild(header);
      });
      
      // è®¡ç®—ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ (0=å‘¨æ—¥,éœ€è¦è½¬æ¢)
      const firstDay = new Date(year, month - 1, 1).getDay();
      const startOffset = (firstDay === 0) ? 6 : firstDay - 1; // è½¬æ¢ä¸º0=å‘¨ä¸€
      
      // å¡«å……ç©ºç™½æ ¼
      for (let i = 0; i < startOffset; i++) {
        const empty = document.createElement('div');
        empty.style.cssText = 'padding:10px; border-radius:8px;';
        calendar.appendChild(empty);
      }
      
      // å¡«å……æ¯ä¸€å¤©
      dailyData.forEach(data => {
        const dayCell = document.createElement('div');
        dayCell.style.cssText = 'text-align:center; padding:10px; border-radius:8px; font-size:12px; font-weight:600;';
        
        // æ ¹æ®çŸ¥è¡Œåˆä¸€ç‡è®¾ç½®é¢œè‰²
        let bgColor = '#f5f5f5';
        let textColor = '#999';
        
        if (data.day > today) {
          // æœªåˆ°æ—¥æœŸ - ç°è‰²
          bgColor = '#f5f5f5';
          textColor = '#ccc';
        } else if (!data.hasData) {
          // æ— æ•°æ® - æµ…ç°
          bgColor = '#f5f5f5';
          textColor = '#999';
        } else if (data.rate >= 80) {
          // ç»¿è‰²
          bgColor = '#4CAF50';
          textColor = 'white';
        } else if (data.rate >= 60) {
          // æ©™è‰²
          bgColor = '#FF9800';
          textColor = 'white';
        } else {
          // çº¢è‰²
          bgColor = '#F44336';
          textColor = 'white';
        }
        
        dayCell.style.backgroundColor = bgColor;
        dayCell.style.color = textColor;
        dayCell.textContent = data.day;
        
        // æ·»åŠ çŸ¥è¡Œåˆä¸€ç‡æç¤º(å°å­—)
        if (data.hasData && data.day <= today) {
          const rateLabel = document.createElement('div');
          rateLabel.style.cssText = 'font-size:9px; margin-top:2px; opacity:0.9;';
          rateLabel.textContent = `${data.rate}%`;
          dayCell.appendChild(rateLabel);
        }
        
        calendar.appendChild(dayCell);
      });
      
      execBox.appendChild(calendar);
      
      // å›¾ä¾‹è¯´æ˜
      const legend = document.createElement('div');
      legend.style.cssText = 'margin-top:15px; display:flex; justify-content:center; gap:15px; font-size:11px;';
      legend.innerHTML = `
        <div style="display:flex; align-items:center; gap:5px;">
          <div style="width:16px; height:16px; background:#4CAF50; border-radius:4px;"></div>
          <span style="color:#666;">â‰¥80%</span>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
          <div style="width:16px; height:16px; background:#FF9800; border-radius:4px;"></div>
          <span style="color:#666;">60-79%</span>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
          <div style="width:16px; height:16px; background:#F44336; border-radius:4px;"></div>
          <span style="color:#666;"><60%</span>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
          <div style="width:16px; height:16px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;"></div>
          <span style="color:#666;">æœªåˆ°</span>
        </div>
      `;
      execBox.appendChild(legend);
      
      card.appendChild(execBox);

      // åº•éƒ¨æ°´å°
      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; color:#999; margin-top:25px; padding-top:20px; border-top:1px solid #e5e5e5;';
      watermark.textContent = `${appState.userName}çš„äººç”Ÿå‰§æœ¬ Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // 8. åˆ†äº«æœˆåº¦AIæ´å¯Ÿ
    async function shareMonthAIInsight() {
      const aiResult = document.getElementById('monthAIResult').textContent;
      if (!aiResult || aiResult.includes('åŠŸèƒ½å¼€å‘ä¸­') || aiResult.trim() === '') {
        alert('è¯·å…ˆè¿›è¡Œæœˆåº¦AIåˆ†æ');
        return;
      }
      
      const card = createMonthAIShareCard();
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        backgroundColor: '#667eea'
      });
      
      document.body.removeChild(card);
      downloadCanvas(canvas, 'æœˆåº¦AIæ´å¯Ÿ');
    }

    // åˆ›å»ºæœˆåº¦AIæ´å¯Ÿåˆ†äº«å¡ç‰‡
    function createMonthAIShareCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px; color:white; font-family: "Noto Sans SC", sans-serif;';

      const title = document.createElement('div');
      title.style.cssText = 'font-size:28px; font-weight:700; margin-bottom:15px; font-family: "Noto Serif SC", serif;';
      title.textContent = `${appState.userName} çš„æœˆåº¦æ´å¯Ÿ`;
      card.appendChild(title);

      const monthInfo = document.createElement('div');
      monthInfo.style.cssText = 'font-size:14px; opacity:0.9; margin-bottom:25px;';
      const now = new Date();
      monthInfo.textContent = `${now.getFullYear()}å¹´ ${now.getMonth() + 1}æœˆ`;
      card.appendChild(monthInfo);

      const content = document.createElement('div');
      content.style.cssText = 'background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); padding:25px; border-radius:12px; font-size:13px; line-height:1.8;';
      
      // ä¼˜åŒ–AIæ–‡æœ¬æ ¼å¼ - å’Œå‘¨åº¦ä¸€è‡´
      let aiText = document.getElementById('monthAIResult').textContent;
      
      // æ¸…ç†å’Œæ ¼å¼åŒ–æ–‡æœ¬
      aiText = aiText
        .replace(/###\s*/g, '')
        .replace(/##\s*/g, '')
        .replace(/#\s*/g, '')
        .replace(/\*\*\*/g, '')
        .replace(/\*\*/g, '')
        .replace(/\*/g, '')
        .replace(/^[\s\n]+/, '')
        .replace(/[\s\n]+$/, '');
      
      // æŒ‰è¡Œå¤„ç†,æ·»åŠ ã€ã€‘æ ‡è®°(å»ºè®®ç±»é™¤å¤–)
      const lines = aiText.split('\n').filter(line => line.trim().length > 0);
      let formattedHTML = '';
      
      lines.forEach((line, idx) => {
        line = line.trim();
        
        // æ£€æµ‹é‡ç‚¹(ä»¥æ•°å­—æˆ–ä¸­æ–‡æ•°å­—å¼€å¤´çš„æ ‡é¢˜)
        const pointMatch = line.match(/^([ä¸€äºŒä¸‰å››äº”1-9])[\sã€\.ï¼ï¼š:]\s*(.+)/);
        if (pointMatch) {
          const title = pointMatch[2];
          // åˆ¤æ–­æ˜¯å¦æ˜¯å»ºè®®ç±»æ ‡é¢˜
          if (title.includes('æ”¹è¿›å»ºè®®') || title.includes('ä¸‹æœˆ') || title.includes('å»ºè®®') || title.includes('ä¼˜åŒ–')) {
            // å»ºè®®ç±» - åªåŠ ç²—,ä¸åŠ ã€ã€‘
            if (idx > 0) formattedHTML += '<div style="height:15px;"></div>';
            formattedHTML += `<div style="font-weight:600; margin-bottom:8px;">${title}</div>`;
          } else {
            // å…¶ä»–é‡ç‚¹ - åŠ ã€ã€‘
            if (idx > 0) formattedHTML += '<div style="height:15px;"></div>';
            formattedHTML += `<div style="font-weight:600; margin-bottom:8px;">ã€${title}ã€‘</div>`;
          }
        }
        // åˆ—è¡¨é¡¹
        else if (line.startsWith('-')) {
          formattedHTML += `<div style="margin:6px 0 6px 15px;">${line}</div>`;
        }
        // æ™®é€šæ®µè½
        else {
          formattedHTML += `<div style="margin:8px 0;">${line}</div>`;
        }
      });
      
      content.innerHTML = formattedHTML;
      card.appendChild(content);

      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; opacity:0.7; margin-top:25px;';
      watermark.innerHTML = `${appState.userName}çš„äººç”Ÿå‰§æœ¬<br>æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // 9. åˆ†äº«æœˆåº¦è¶‹åŠ¿å¡ç‰‡
    async function shareMonthTrendCard() {
      const card = createMonthTrendCard();
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        backgroundColor: '#ffffff'
      });
      
      document.body.removeChild(card);
      downloadCanvas(canvas, 'æœˆåº¦è¶‹åŠ¿');
    }

    // åˆ›å»ºæœˆåº¦è¶‹åŠ¿å¡ç‰‡(åªåŒ…å«è¶‹åŠ¿è¿›åº¦æ¡)
    function createMonthTrendCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:white; padding:40px; font-family: "Noto Sans SC", sans-serif;';

      const header = document.createElement('div');
      header.style.cssText = 'margin-bottom:30px;';
      
      const title = document.createElement('div');
      title.style.cssText = 'font-size:24px; font-weight:700; color:#2C2C2C; margin-bottom:10px;';
      title.textContent = 'ğŸ“ˆ æœˆåº¦è¶‹åŠ¿';
      header.appendChild(title);
      
      const subtitle = document.createElement('div');
      subtitle.style.cssText = 'font-size:14px; color:#8B8B8B;';
      const now = new Date();
      subtitle.textContent = `${appState.userName} Â· ${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
      header.appendChild(subtitle);
      
      card.appendChild(header);

      const monthData = getMonthData();

      // æœˆåº¦ç»Ÿè®¡å¡ç‰‡
      const statsCard = document.createElement('div');
      statsCard.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:25px; margin-bottom:25px; text-align:center;';
      statsCard.innerHTML = `
        <div style="font-size:48px; font-weight:700; color:#2C2C2C; margin-bottom:10px;">${monthData.completionRate}%</div>
        <div style="font-size:14px; color:#8B8B8B;">æœˆåº¦çŸ¥è¡Œåˆä¸€ç‡</div>
      `;
      card.appendChild(statsCard);

      // å‘¨åº¦è¶‹åŠ¿
      if (monthData.weeklyStats.length > 0) {
        const trendBox = document.createElement('div');
        trendBox.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:20px;';
        
        const trendTitle = document.createElement('div');
        trendTitle.style.cssText = 'font-size:15px; font-weight:600; margin-bottom:15px; color:#2C2C2C;';
        trendTitle.textContent = 'ğŸ“Š å‘¨åº¦å˜åŒ–';
        trendBox.appendChild(trendTitle);
        
        monthData.weeklyStats.forEach((stat, idx) => {
          const bar = document.createElement('div');
          bar.style.cssText = 'margin-bottom:15px;';
          
          const label = document.createElement('div');
          label.style.cssText = 'display:flex; justify-content:space-between; font-size:14px; margin-bottom:8px; color:#2C2C2C;';
          label.innerHTML = `<span style="font-weight:600;">ç¬¬${idx + 1}å‘¨</span><span style="font-weight:700; color:#667eea;">${stat.rate}%</span>`;
          
          const track = document.createElement('div');
          track.style.cssText = 'height:12px; background:#e5e5e5; border-radius:6px; overflow:hidden;';
          
          const fill = document.createElement('div');
          fill.style.cssText = `width:${stat.rate}%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2); transition:width 0.3s;`;
          
          track.appendChild(fill);
          bar.appendChild(label);
          bar.appendChild(track);
          trendBox.appendChild(bar);
        });
        
        card.appendChild(trendBox);
      }

      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; color:#999; margin-top:25px; padding-top:20px; border-top:1px solid #e5e5e5;';
      watermark.textContent = `${appState.userName}çš„äººç”Ÿå‰§æœ¬ Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // 10. åˆ†äº«æœˆåº¦æ•°æ®æ€»ç»“å¡ç‰‡
    async function shareMonthSummaryCard() {
      const card = createMonthSummaryCard();
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        backgroundColor: '#ffffff'
      });
      
      document.body.removeChild(card);
      downloadCanvas(canvas, 'æœˆåº¦æ€»ç»“');
    }

    // åˆ›å»ºæœˆåº¦æ•°æ®æ€»ç»“å¡ç‰‡(ç®€æ´ç‰ˆ,åªåŒ…å«å…³é”®æ•°æ®)
    function createMonthSummaryCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:white; padding:40px; font-family: "Noto Sans SC", sans-serif;';

      const header = document.createElement('div');
      header.style.cssText = 'margin-bottom:30px; text-align:center;';
      
      const title = document.createElement('div');
      title.style.cssText = 'font-size:28px; font-weight:700; color:#2C2C2C; margin-bottom:10px;';
      const now = new Date();
      title.textContent = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆæ€»ç»“`;
      header.appendChild(title);
      
      const subtitle = document.createElement('div');
      subtitle.style.cssText = 'font-size:14px; color:#8B8B8B;';
      subtitle.textContent = appState.userName;
      header.appendChild(subtitle);
      
      card.appendChild(header);

      const monthData = getMonthData();

      // å…³é”®æ•°æ® - 2x2ç½‘æ ¼
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:25px;';
      
      grid.innerHTML = `
        <div style="background:#f9f9f9; border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:36px; font-weight:700; color:#667eea; margin-bottom:8px;">${monthData.completionRate}%</div>
          <div style="font-size:12px; color:#8B8B8B;">çŸ¥è¡Œåˆä¸€ç‡</div>
        </div>
        <div style="background:#f9f9f9; border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:36px; font-weight:700; color:#764ba2; margin-bottom:8px;">${monthData.weeklyStats.length}</div>
          <div style="font-size:12px; color:#8B8B8B;">å·²è®°å½•å‘¨æ•°</div>
        </div>
        <div style="background:#f9f9f9; border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:36px; font-weight:700; color:#4CAF50; margin-bottom:8px;">${monthData.totalDone}</div>
          <div style="font-size:12px; color:#8B8B8B;">å®Œæˆæ—¶æ®µ</div>
        </div>
        <div style="background:#f9f9f9; border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:36px; font-weight:700; color:#FF9800; margin-bottom:8px;">${monthData.totalPlanned}</div>
          <div style="font-size:12px; color:#8B8B8B;">è®¡åˆ’æ—¶æ®µ</div>
        </div>
      `;
      card.appendChild(grid);

      // æœ€ä½³è¡¨ç°å‘¨
      if (monthData.weeklyStats.length > 0) {
        const bestWeek = monthData.weeklyStats.reduce((best, curr, idx) => 
          curr.rate > best.rate ? {rate: curr.rate, week: idx + 1} : best,
          {rate: 0, week: 0}
        );
        
        const highlight = document.createElement('div');
        highlight.style.cssText = 'background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; padding:20px; text-align:center; color:white;';
        highlight.innerHTML = `
          <div style="font-size:14px; opacity:0.9; margin-bottom:8px;">ğŸ† æœ€ä½³è¡¨ç°</div>
          <div style="font-size:20px; font-weight:600;">ç¬¬${bestWeek.week}å‘¨ Â· ${bestWeek.rate}%</div>
        `;
        card.appendChild(highlight);
      }

      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; color:#999; margin-top:25px; padding-top:20px; border-top:1px solid #e5e5e5;';
      watermark.textContent = `${appState.userName}çš„äººç”Ÿå‰§æœ¬ Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // æ•è·å‘¨è¡¨æ ¼
    async function captureWeekTable(type) {
      const container = document.createElement('div');
      container.style.cssText = 'position:fixed; top:-10000px; left:0; background:white; padding:30px; border-radius:20px; font-family: "Noto Sans SC", sans-serif;';
      
      // æ ‡é¢˜
      const title = document.createElement('div');
      title.style.cssText = 'font-size:24px; font-weight:700; margin-bottom:10px; font-family: "Noto Serif SC", serif;';
      title.textContent = `${appState.userName} çš„äººç”Ÿå‰§æœ¬`;
      container.appendChild(title);

      // å‘¨ä¿¡æ¯
      const weekInfo = document.createElement('div');
      weekInfo.style.cssText = 'font-size:13px; color:#999; margin-bottom:20px;';
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const beijingTime = new Date(utc + (3600000 * 8));
      const weekNum = getWeekNumber(beijingTime);
      weekInfo.textContent = `2026å¹´ ç¬¬${weekNum}å‘¨`;
      container.appendChild(weekInfo);

      // è¡¨æ ¼
      const table = document.createElement('div');
      table.style.cssText = 'display:grid; grid-template-columns:50px repeat(7,60px); gap:4px;';

      // è¡¨å¤´
      const days = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
      days.forEach((d, i) => {
        const th = document.createElement('div');
        th.style.cssText = 'text-align:center; font-size:12px; font-weight:600; padding:8px; background:#f5f5f5; border-radius:8px;';
        if (i > 0 && i - 1 === appState.currentDay) {
          th.style.background = '#333';
          th.style.color = 'white';
        }
        th.textContent = d;
        table.appendChild(th);
      });

      // æ—¶é—´è¡Œ
      for (let hour = 7; hour <= 23; hour++) {
        // æ—¶é—´æ ‡ç­¾
        const timeCell = document.createElement('div');
        timeCell.style.cssText = 'text-align:center; font-size:10px; color:#999; padding:8px 0; font-family:monospace;';
        timeCell.textContent = `${hour}:00`;
        table.appendChild(timeCell);

        // æ¯å¤©çš„æ ¼å­
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.style.cssText = 'min-height:35px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:10px; padding:4px;';

          const task = appState.weekPlan[day]?.[hour];
          const checkin = appState.weekCheckin[day]?.[hour];

          if (type === 'plan') {
            // å‘¨è®¡åˆ’æ¨¡å¼ - æ˜¾ç¤ºè®¡åˆ’å†…å®¹
            if (task) {
              const cat = appState.categories[task.category];
              cell.style.background = cat.color;
              cell.textContent = task.tag;
              cell.style.fontWeight = '500';
            } else {
              cell.style.background = '#fafafa';
              cell.style.border = '1px solid #eee';
            }
          } else {
            // æ‰§è¡Œæƒ…å†µæ¨¡å¼ - æ˜¾ç¤ºæ‰“å¡çŠ¶æ€
            if (task) {
              if (checkin === 'done') {
                cell.style.background = '#95D7AE';
                cell.textContent = 'âœ“';
                cell.style.fontSize = '16px';
              } else if (checkin?.status === 'undone') {
                cell.style.background = '#F4A7A7';
                cell.textContent = 'âœ—';
                cell.style.fontSize = '16px';
              } else {
                const cat = appState.categories[task.category];
                cell.style.background = cat.color;
                cell.style.opacity = '0.3';
                cell.textContent = task.tag;
              }
            } else {
              cell.style.background = '#fafafa';
              cell.style.border = '1px solid #eee';
            }
          }

          // é«˜äº®ä»Šå¤©
          if (day === appState.currentDay && task) {
            cell.style.border = '2px solid #333';
          }

          table.appendChild(cell);
        }
      }

      container.appendChild(table);

      // åº•éƒ¨æ°´å°
      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; color:#999; margin-top:20px;';
      watermark.innerHTML = `${appState.userName}çš„äººç”Ÿå‰§æœ¬<br>æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      container.appendChild(watermark);

      document.body.appendChild(container);

      const canvas = await html2canvas(container, {
        backgroundColor: 'white',
        scale: 2,
        logging: false
      });

      document.body.removeChild(container);
      return canvas;
    }

    // åˆ›å»ºAIæ´å¯Ÿåˆ†äº«å¡ç‰‡
    function createAIShareCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px; color:white; font-family: "Noto Sans SC", sans-serif;';

      const title = document.createElement('div');
      title.style.cssText = 'font-size:28px; font-weight:700; margin-bottom:15px; font-family: "Noto Serif SC", serif;';
      title.textContent = `${appState.userName} çš„äººç”Ÿæ´å¯Ÿ`;
      card.appendChild(title);

      const weekInfo = document.createElement('div');
      weekInfo.style.cssText = 'font-size:14px; opacity:0.9; margin-bottom:25px;';
      const now = new Date();
      const weekNum = getWeekNumber(now);
      weekInfo.textContent = `2026å¹´ ç¬¬${weekNum}å‘¨`;
      card.appendChild(weekInfo);

      const content = document.createElement('div');
      content.style.cssText = 'background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:12px; padding:25px; font-size:13px; line-height:1.8;';
      
      // ä»aiResultçš„innerHTMLè·å–,å·²ç»åŒ…å«æ ¼å¼åŒ–
      let aiHTML = document.getElementById('aiResult').innerHTML;
      
      // ç§»é™¤æ ‡é¢˜
      aiHTML = aiHTML.replace(/<div[^>]*>ğŸ¬ å¯¼æ¼”è§†è§’ Â· AI æ´å¯Ÿ<\/div>/g, '');
      
      content.innerHTML = aiHTML;
      card.appendChild(content);

      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; opacity:0.7; margin-top:25px;';
      watermark.innerHTML = `${appState.userName}çš„äººç”Ÿå‰§æœ¬<br>æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // åˆ›å»ºç»Ÿè®¡æ•°æ®å¡ç‰‡
    function createStatShareCard() {
      const card = document.createElement('div');
      card.style.cssText = 'position:fixed; top:-10000px; left:0; width:600px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px; color:white; font-family: "Noto Sans SC", sans-serif;';

      const title = document.createElement('div');
      title.style.cssText = 'font-size:28px; font-weight:700; margin-bottom:20px; font-family: "Noto Serif SC", serif;';
      title.textContent = `${appState.userName} çš„äººç”Ÿå‰§æœ¬`;
      card.appendChild(title);

      const weekInfo = document.createElement('div');
      weekInfo.style.cssText = 'font-size:14px; opacity:0.9; margin-bottom:30px;';
      const now = new Date();
      const weekNum = getWeekNumber(now);
      weekInfo.textContent = `2026å¹´ ç¬¬${weekNum}å‘¨`;
      card.appendChild(weekInfo);

      const analysisData = buildDetailedAnalysisData();

      const statsBox = document.createElement('div');
      statsBox.style.cssText = 'background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:16px; padding:25px;';

      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;';
      stats.innerHTML = `
        <div style="text-align:center;">
          <div style="font-size:42px; font-weight:700;">${analysisData.completionRate}%</div>
          <div style="font-size:13px; opacity:0.8; margin-top:5px;">çŸ¥è¡Œåˆä¸€ç‡</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:42px; font-weight:700;">${analysisData.totalDone}/${analysisData.totalPlanned}</div>
          <div style="font-size:13px; opacity:0.8; margin-top:5px;">å®Œæˆæ—¶æ®µ</div>
        </div>
      `;
      statsBox.appendChild(stats);

      const dist = document.createElement('div');
      dist.style.cssText = 'font-size:13px; line-height:1.8; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;';
      let distHTML = '';
      Object.keys(analysisData.actualDistribution).forEach(key => {
        const cat = appState.categories[key];
        const hours = analysisData.actualDistribution[key];
        const percent = analysisData.actualTotal > 0 ? Math.round(hours/analysisData.actualTotal*100) : 0;
        distHTML += `
          <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span>${cat.name}</span>
            <span>${hours}h (${percent}%)</span>
          </div>`;
      });
      dist.innerHTML = distHTML;
      statsBox.appendChild(dist);

      card.appendChild(statsBox);

      const watermark = document.createElement('div');
      watermark.style.cssText = 'text-align:center; font-size:11px; opacity:0.6; margin-top:30px;';
      watermark.innerHTML = `${appState.userName}çš„äººç”Ÿå‰§æœ¬<br>æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`;
      card.appendChild(watermark);

      document.body.appendChild(card);
      return card;
    }

    // ä¸‹è½½canvas
    async function downloadCanvas(canvas, name) {
      try {
        // è½¬æ¢ä¸ºblob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        // å°è¯•ä½¿ç”¨åŸç”Ÿåˆ†äº«API
        if (navigator.share && navigator.canShare) {
          const file = new File([blob], `${name}.png`, { type: 'image/png' });
          
          // æ£€æŸ¥æ˜¯å¦æ”¯æŒåˆ†äº«æ–‡ä»¶
          if (navigator.canShare({ files: [file] })) {
            await navigator.share({
              files: [file],
              title: `${appState.userName}çš„äººç”Ÿå‰§æœ¬`,
              text: `${name} - æ¯ä¸€å¤©éƒ½è¦ç²¾å½©åœ°æ´»`
            });
            return; // åˆ†äº«æˆåŠŸ,ç›´æ¥è¿”å›
          }
        }
        
        // é™çº§æ–¹æ¡ˆ:ä¸‹è½½å›¾ç‰‡
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const weekNum = getWeekNumber(now);
        a.download = `${name}_${appState.userName}_ç¬¬${weekNum}å‘¨.png`;
        a.click();
        URL.revokeObjectURL(url);
        
      } catch(error) {
        // ç”¨æˆ·å–æ¶ˆåˆ†äº«æˆ–å…¶ä»–é”™è¯¯
        if (error.name !== 'AbortError') {
          console.error('åˆ†äº«å¤±è´¥:', error);
          alert('åˆ†äº«å¤±è´¥,å›¾ç‰‡å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹');
        }
      }
    }

    // æ—§çš„åˆ†äº«å‡½æ•°(ä¿ç•™å…¼å®¹)
    function generateShareImage() {
      shareStatCard();
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('show');
    }

    async function downloadShareImage() {
      const card = document.getElementById('shareCard');
      
      try {
        const canvas = await html2canvas(card, {
          backgroundColor: null,
          scale: 2,
          logging: false,
          useCORS: true
        });
        
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `äººç”Ÿå‰§æœ¬_${appState.userName}_ç¬¬${getWeekNumber(new Date())}å‘¨.png`;
          a.click();
          URL.revokeObjectURL(url);
          
          alert('âœ… åˆ†äº«å¡ç‰‡å·²ä¿å­˜!');
        });
      } catch (error) {
        console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
        alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥,è¯·é‡è¯•');
      }
    }

    // ========== åˆ†ç±»é…ç½® ==========
    function renderCategoryConfig() {
      const container = document.getElementById('categoryConfig');
      container.innerHTML = '';

      Object.keys(appState.categories).forEach(key => {
        const cat = appState.categories[key];
        
        const item = document.createElement('div');
        item.style.marginBottom = '20px';
        item.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <input type="color" class="color-picker" value="${cat.color}" onchange="updateCategoryColor('${key}', this.value)">
            <input type="text" class="category-name-input" value="${cat.name}" onchange="updateCategoryName('${key}', this.value)">
          </div>
        `;

        const tagList = document.createElement('div');
        tagList.className = 'tag-list';
        
        cat.tags.forEach(tag => {
          const tagItem = document.createElement('div');
          tagItem.className = 'tag-item';
          tagItem.innerHTML = `
            <span>${tag}</span>
            <span class="tag-remove" onclick="removeTag('${key}', '${tag}')">Ã—</span>
          `;
          tagList.appendChild(tagItem);
        });

        // æ·»åŠ è¾“å…¥æ¡†å’ŒæŒ‰é’®
        const addContainer = document.createElement('div');
        addContainer.style.cssText = 'display:flex; gap:8px; align-items:center;';
        
        const addInput = document.createElement('input');
        addInput.className = 'add-tag-input';
        addInput.placeholder = 'è¾“å…¥æ–°æ ‡ç­¾';
        addInput.id = `add-tag-${key}`;
        addInput.style.flex = '1';
        
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-secondary';
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.style.cssText = 'padding:6px 12px; font-size:12px; white-space:nowrap;';
        addBtn.onclick = () => {
          const input = document.getElementById(`add-tag-${key}`);
          if (input.value.trim()) {
            addTag(key, input.value.trim());
            input.value = '';
          }
        };
        
        addContainer.appendChild(addInput);
        addContainer.appendChild(addBtn);
        tagList.appendChild(addContainer);

        item.appendChild(tagList);
        container.appendChild(item);
      });
    }

    function updateCategoryColor(key, color) {
      appState.categories[key].color = color;
      saveData();
      renderCategorySelector();
      renderWeekTable();
      renderCheckinList();
    }

    function updateCategoryName(key, name) {
      appState.categories[key].name = name;
      saveData();
      renderCategorySelector();
    }

    function addTag(key, tag) {
      if (!appState.categories[key].tags.includes(tag)) {
        appState.categories[key].tags.push(tag);
        saveData();
        renderCategoryConfig();
        renderTagSelector();
        
        // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯è¿™ä¸ªåˆ†ç±»,åˆ·æ–°æ ‡ç­¾é€‰æ‹©å™¨
        if (appState.selectedCategory === key) {
          renderTagSelector();
        }
      }
    }

    function removeTag(key, tag) {
      appState.categories[key].tags = appState.categories[key].tags.filter(t => t !== tag);
      saveData();
      renderCategoryConfig();
      
      // å¦‚æœå½“å‰é€‰ä¸­çš„æ ‡ç­¾è¢«åˆ é™¤,æ¸…ç©ºé€‰æ‹©
      if (appState.selectedTag === tag) {
        appState.selectedTag = null;
      }
      renderTagSelector();
    }

    // ========== è§†å›¾åˆ‡æ¢ ==========
    let currentReviewView = 'week';
    
    function switchReviewView(view) {
      currentReviewView = view;
      
      if (view === 'week') {
        document.getElementById('weekView').style.display = 'block';
        document.getElementById('monthView').style.display = 'none';
        document.getElementById('viewWeekBtn').classList.add('btn-primary');
        document.getElementById('viewWeekBtn').classList.remove('btn-secondary');
        document.getElementById('viewMonthBtn').classList.remove('btn-primary');
        document.getElementById('viewMonthBtn').classList.add('btn-secondary');
        
        renderReviewPage();
      } else {
        document.getElementById('weekView').style.display = 'none';
        document.getElementById('monthView').style.display = 'block';
        document.getElementById('viewMonthBtn').classList.add('btn-primary');
        document.getElementById('viewMonthBtn').classList.remove('btn-secondary');
        document.getElementById('viewWeekBtn').classList.remove('btn-primary');
        document.getElementById('viewWeekBtn').classList.add('btn-secondary');
        
        renderMonthView();
      }
    }
    
    // ========== æœˆåº¦è§†å›¾æ¸²æŸ“ ==========
    function renderMonthView() {
      const monthData = getMonthData();
      
      // æ¸²æŸ“æœˆåº¦ç»Ÿè®¡
      document.getElementById('monthCompletion').textContent = `${monthData.completionRate}%`;
      document.getElementById('monthTotal').textContent = `${monthData.totalDone}/${monthData.totalPlanned}`;
      
      // æ¸²æŸ“å‘¨åº¦è¶‹åŠ¿
      renderWeekTrend(monthData.weeklyStats);
      
      // æ¸²æŸ“æ—¶é—´åˆ†å¸ƒé¥¼å›¾
      renderMonthPieChart(monthData.categoryDistribution);
      
      // åŠ è½½æœˆåº¦å¤ç›˜ç¬”è®°
      loadMonthNotes();
    }
    
    // è·å–æœ¬æœˆæ•°æ®
    function getMonthData() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      
      let totalPlanned = 0;
      let totalDone = 0;
      const weeklyStats = [];
      const categoryDistribution = {};
      
      // éå†æœ¬æœˆçš„æ‰€æœ‰å‘¨æ•°æ®
      Object.keys(appState.weeklyData).forEach(weekKey => {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬æœˆçš„å‘¨(ç®€åŒ–ç‰ˆ,å®é™…å¯ä»¥æ›´ç²¾ç¡®)
        if (weekKey.startsWith(`${year}-`)) {
          const weekData = appState.weeklyData[weekKey];
          const plan = weekData.plan || {};
          const checkin = weekData.checkin || {};
          
          let weekPlanned = 0;
          let weekDone = 0;
          
          for (let day = 0; day < 7; day++) {
            for (let hour = 7; hour <= 23; hour++) {
              const task = plan[day]?.[hour];
              if (!task) continue;
              
              weekPlanned++;
              const checkinStatus = checkin[day]?.[hour];
              
              if (checkinStatus === 'done') {
                weekDone++;
                const cat = task.category;
                categoryDistribution[cat] = (categoryDistribution[cat] || 0) + 1;
              } else if (checkinStatus?.reason) {
                const cat = checkinStatus.reason.category;
                categoryDistribution[cat] = (categoryDistribution[cat] || 0) + 1;
              }
            }
          }
          
          totalPlanned += weekPlanned;
          totalDone += weekDone;
          
          weeklyStats.push({
            week: weekKey,
            rate: weekPlanned > 0 ? Math.round((weekDone / weekPlanned) * 100) : 0
          });
        }
      });
      
      return {
        totalPlanned,
        totalDone,
        completionRate: totalPlanned > 0 ? Math.round((totalDone / totalPlanned) * 100) : 0,
        weeklyStats,
        categoryDistribution
      };
    }
    
    // æ¸²æŸ“å‘¨åº¦è¶‹åŠ¿(ç®€åŒ–ç‰ˆæ–‡å­—åˆ—è¡¨)
    function renderWeekTrend(weeklyStats) {
      const container = document.getElementById('weekTrend');
      container.innerHTML = '';
      
      if (weeklyStats.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999;">æš‚æ— æ•°æ®</div>';
        return;
      }
      
      weeklyStats.forEach((stat, idx) => {
        const bar = document.createElement('div');
        bar.style.cssText = 'margin-bottom:15px;';
        
        const label = document.createElement('div');
        label.style.cssText = 'display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px;';
        label.innerHTML = `<span>ç¬¬${idx + 1}å‘¨ (${stat.week})</span><span>${stat.rate}%</span>`;
        
        const track = document.createElement('div');
        track.style.cssText = 'height:24px; background:#f5f5f5; border-radius:12px; overflow:hidden;';
        
        const fill = document.createElement('div');
        fill.style.cssText = `width:${stat.rate}%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2); transition:width 0.6s;`;
        
        track.appendChild(fill);
        bar.appendChild(label);
        bar.appendChild(track);
        container.appendChild(bar);
      });
    }
    
    // æ¸²æŸ“æ—¶é—´åˆ†å¸ƒé¥¼å›¾(Canvas)
    function renderMonthPieChart(distribution) {
      const canvas = document.getElementById('monthPieChart');
      const ctx = canvas.getContext('2d');
      const centerX = 150;
      const centerY = 150;
      const radius = 100;
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, 300, 300);
      
      const total = Object.values(distribution).reduce((a, b) => a + b, 0);
      if (total === 0) {
        ctx.fillStyle = '#999';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('æš‚æ— æ•°æ®', centerX, centerY);
        return;
      }
      
      let currentAngle = -Math.PI / 2; // ä»12ç‚¹é’Ÿæ–¹å‘å¼€å§‹
      
      Object.keys(distribution).forEach(key => {
        const cat = appState.categories[key];
        const value = distribution[key];
        const angle = (value / total) * 2 * Math.PI;
        
        // ç»˜åˆ¶æ‰‡å½¢
        ctx.fillStyle = cat.color;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + angle);
        ctx.closePath();
        ctx.fill();
        
        // ä¸ç»˜åˆ¶è¾¹æ¡†,é¿å…ç¼éš™
        
        currentAngle += angle;
      });
      
      // æ¸²æŸ“å›¾ä¾‹
      const listContainer = document.getElementById('monthCategoryList');
      listContainer.innerHTML = '';
      listContainer.style.cssText = 'margin-top:20px;';
      
      Object.keys(distribution).forEach(key => {
        const cat = appState.categories[key];
        const value = distribution[key];
        const percent = Math.round((value / total) * 100);
        
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:8px; background:#f9f9f9; border-radius:8px;';
        item.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;">
            <div style="width:16px; height:16px; background:${cat.color}; border-radius:4px;"></div>
            <span>${cat.name}</span>
          </div>
          <span style="font-weight:600;">${value}h (${percent}%)</span>
        `;
        listContainer.appendChild(item);
      });
    }
    
    // åŠ è½½æœˆåº¦ç¬”è®°
    function loadMonthNotes() {
      const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
      const monthNotes = appState.weeklyData[`${monthKey}-notes`] || {};
      
      document.getElementById('monthAchievement').value = monthNotes.achievement || '';
      document.getElementById('monthChallenge').value = monthNotes.challenge || '';
      document.getElementById('monthGoals').value = monthNotes.goals || '';
      
      // ç»‘å®šä¿å­˜äº‹ä»¶
      ['monthAchievement', 'monthChallenge', 'monthGoals'].forEach(id => {
        const el = document.getElementById(id);
        el.onblur = () => {
          const key = id.replace('month', '').toLowerCase();
          if (!appState.weeklyData[`${monthKey}-notes`]) {
            appState.weeklyData[`${monthKey}-notes`] = {};
          }
          appState.weeklyData[`${monthKey}-notes`][key] = el.value;
          saveData();
        };
      });
    }
    
    // æœˆåº¦AIåˆ†æ
    async function analyzeMonth() {
      const apiKey = appState.apiKey || document.getElementById('apiKey').value;
      if (!apiKey) {
        alert('è¯·å…ˆåœ¨å·¥å…·é¡µé…ç½®API Key');
        return;
      }

      const monthData = getMonthData();
      
      if (monthData.totalPlanned === 0) {
        alert('æœ¬æœˆæš‚æ— æ•°æ®,è¯·å…ˆå®Œæˆæœ¬å‘¨è®¡åˆ’å’Œæ‰“å¡');
        return;
      }

      const btn = document.getElementById('monthAiBtn');
      const btnText = document.getElementById('monthAiBtnText');
      const result = document.getElementById('monthAIResult');

      btn.disabled = true;
      btnText.textContent = 'â³ AI æ­£åœ¨æ·±åº¦åˆ†æ...';
      result.classList.remove('show');

      try {
        const prompt = buildMonthAnalysisPrompt(monthData);
        const provider = appState.apiProvider || 'deepseek';
        
        console.log('æœˆåº¦AIåˆ†æ - æä¾›å•†:', provider);
        console.log('æœˆåº¦AIåˆ†æ - æç¤ºè¯é•¿åº¦:', prompt.length);
        
        let response;
        
        if (provider === 'deepseek') {
          console.log('æœˆåº¦AIåˆ†æ - ä½¿ç”¨DeepSeek API');
          response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: [
                {
                  role: 'system',
                  content: 'ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä¸ªäººæˆé•¿æ•™ç»ƒ,æ“…é•¿ä»é•¿æœŸè¶‹åŠ¿è§’åº¦åˆ†æç”¨æˆ·çš„æ—¶é—´ç®¡ç†æ•°æ®ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.7,
              max_tokens: 2000
            })
          });
        } else {
          // æ™ºè°±API
          console.log('æœˆåº¦AIåˆ†æ - ä½¿ç”¨æ™ºè°± API');
          response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'glm-4',
              messages: [
                {
                  role: 'system',
                  content: 'ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä¸ªäººæˆé•¿æ•™ç»ƒ,æ“…é•¿ä»é•¿æœŸè¶‹åŠ¿è§’åº¦åˆ†æç”¨æˆ·çš„æ—¶é—´ç®¡ç†æ•°æ®ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.7
            })
          });
        }

        console.log('æœˆåº¦AIåˆ†æ - å“åº”çŠ¶æ€:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('æœˆåº¦AIåˆ†æ - APIé”™è¯¯:', errorText);
          throw new Error(`APIé”™è¯¯ (${response.status})`);
        }

        const data = await response.json();
        console.log('æœˆåº¦AIåˆ†æ - æˆåŠŸè·å–å“åº”');
        
        // å¢å¼ºæ–‡æœ¬æ¸…ç† - å»é™¤æ‰€æœ‰Markdownæ ¼å¼
        let analysis = data.choices[0].message.content
          .replace(/###\s*/g, '')        // å»é™¤ ###
          .replace(/##\s*/g, '')         // å»é™¤ ##
          .replace(/#\s*/g, '')          // å»é™¤ #
          .replace(/\*\*\*/g, '')        // å»é™¤ ***
          .replace(/\*\*/g, '')          // å»é™¤ **
          .replace(/\*/g, '')            // å»é™¤ *
          .replace(/ã€/g, '\n\nã€')      // ã€å‰æ¢è¡Œ
          .replace(/ã€‘/g, 'ã€‘\n')         // ã€‘åæ¢è¡Œ
          .replace(/(\d+)\.\s*/g, '\n\n$1. ') // æ•°å­—åˆ—è¡¨å‰æ¢è¡Œ
          .replace(/ã€‚\s*(\d+\.)/g, 'ã€‚\n\n$1') // å¥å·åæ•°å­—å‰æ¢è¡Œ
          .replace(/^[\s\n]+/, '')       // å»é™¤å¼€å¤´ç©ºç™½
          .replace(/[\s\n]+$/, '')       // å»é™¤ç»“å°¾ç©ºç™½
          .replace(/\n{3,}/g, '\n\n');   // æœ€å¤š2ä¸ªæ¢è¡Œ

        result.textContent = analysis;
        result.classList.add('show');
        btnText.textContent = 'âœ… åˆ†æå®Œæˆ';
        
        setTimeout(() => {
          btnText.textContent = 'âœ¨ AI åˆ†ææœ¬æœˆæ•°æ®';
          btn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('æœˆåº¦AIåˆ†æå¤±è´¥:', error);
        
        let errorMsg = `åˆ†æå¤±è´¥: ${error.message}\n\n`;
        errorMsg += 'è¯·æ£€æŸ¥:\n1. API Keyæ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. APIé¢åº¦æ˜¯å¦å……è¶³';
        
        result.textContent = errorMsg;
        result.classList.add('show');
        btnText.textContent = 'âœ¨ AI åˆ†ææœ¬æœˆæ•°æ®';
        btn.disabled = false;
      }
    }

    // æ„å»ºæœˆåº¦åˆ†ææç¤ºè¯
    function buildMonthAnalysisPrompt(monthData) {
      const now = new Date();
      const monthName = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
      
      let prompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä¸ªäººæˆé•¿æ•™ç»ƒ,è¯·æ ¹æ®ä»¥ä¸‹æœˆåº¦æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æ:\n\n`;
      prompt += `ã€åŸºæœ¬ä¿¡æ¯ã€‘\n`;
      prompt += `æ—¶é—´èŒƒå›´: ${monthName}\n`;
      prompt += `å·²è®°å½•å‘¨æ•°: ${monthData.weeklyStats.length}å‘¨\n`;
      prompt += `æœˆåº¦çŸ¥è¡Œåˆä¸€ç‡: ${monthData.completionRate}%\n`;
      prompt += `å®Œæˆ/è®¡åˆ’: ${monthData.totalDone}/${monthData.totalPlanned}æ—¶æ®µ\n\n`;
      
      if (monthData.weeklyStats.length > 0) {
        prompt += `ã€å‘¨åº¦è¶‹åŠ¿ã€‘\n`;
        monthData.weeklyStats.forEach((stat, idx) => {
          prompt += `ç¬¬${idx + 1}å‘¨: ${stat.rate}%\n`;
        });
        prompt += `\n`;
      }
      
      if (Object.keys(monthData.categoryDistribution).length > 0) {
        prompt += `ã€æ—¶é—´åˆ†é…ã€‘\n`;
        Object.keys(monthData.categoryDistribution).forEach(key => {
          const cat = appState.categories[key];
          const hours = monthData.categoryDistribution[key];
          const percent = monthData.totalDone > 0 ? Math.round((hours / monthData.totalDone) * 100) : 0;
          prompt += `${cat.name}: ${hours}å°æ—¶ (${percent}%)\n`;
        });
      }
      
      prompt += `\nã€åˆ†æè¦æ±‚ã€‘\n`;
      prompt += `1. è¯†åˆ«è¶‹åŠ¿: åˆ†æå‘¨åº¦çŸ¥è¡Œåˆä¸€ç‡çš„å˜åŒ–è¶‹åŠ¿\n`;
      prompt += `2. å‘ç°è§„å¾‹: æ‰¾å‡ºæ—¶é—´åˆ†é…çš„ç‰¹ç‚¹å’Œæ¨¡å¼\n`;
      prompt += `3. æä¾›å»ºè®®: ç»™å‡º3æ¡å…·ä½“å¯è¡Œçš„æ”¹è¿›å»ºè®®\n`;
      prompt += `4. ä¸‹æœˆç›®æ ‡: å»ºè®®ä¸‹æœˆé‡ç‚¹ä¼˜åŒ–çš„æ–¹å‘\n\n`;
      prompt += `è¯·ç”¨ç®€æ´çš„è¯­è¨€,åˆ†æ¡ä½œç­”,æ¯æ¡å»ºè®®è¦å…·ä½“ä¸”å¯æ“ä½œã€‚`;
      
      return prompt;
    }

    // ========== å¼•å¯¼é¡µåŠŸèƒ½ ==========
    let currentSlide = 0;
    const totalSlides = 4;

    function goToSlide(index) {
      if (index < 0 || index >= totalSlides) return;
      
      // éšè—å½“å‰é¡µ
      const slides = document.querySelectorAll('.intro-slide');
      slides[currentSlide].style.display = 'none';
      
      // æ˜¾ç¤ºç›®æ ‡é¡µ
      currentSlide = index;
      slides[currentSlide].style.display = 'block';
      
      // æ›´æ–°å¯¼èˆªç‚¹
      const dots = document.querySelectorAll('.intro-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentSlide);
      });
      
      // æ›´æ–°æŒ‰é’®æ–‡å­—
      const nextBtn = document.getElementById('nextBtn');
      if (currentSlide === totalSlides - 1) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'block';
        nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
      }
    }

    function nextSlide() {
      goToSlide(currentSlide + 1);
    }

    function startApp() {
      // å¼¹çª—è¯¢é—®å§“å
      const userName = prompt('ğŸ¬ è¯·è¾“å…¥æ‚¨çš„å§“å,å¼€å¯ä¸“å±äººç”Ÿå‰§æœ¬:', appState.userName);
      if (userName && userName.trim()) {
        appState.userName = userName.trim();
        document.getElementById('userNameDisplay').textContent = appState.userName;
        saveData();
      }
      
      document.getElementById('intro-layer').classList.add('hide');
      
      // è®¾ç½®é¦–æ¬¡ä½¿ç”¨æ ‡è®°
      localStorage.setItem('lifeScriptFirstUse', 'false');
    }

    // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
    function checkFirstUse() {
      const firstUse = localStorage.getItem('lifeScriptFirstUse');
      if (firstUse === 'false') {
        // ä¸æ˜¯é¦–æ¬¡ä½¿ç”¨,ç›´æ¥è·³è¿‡å¼•å¯¼
        document.getElementById('intro-layer').style.display = 'none';
      }
    }

    // ========== é¡µé¢åˆ‡æ¢ ==========
    function switchPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');

      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      event.currentTarget.classList.add('active');

      if (page === 'review') {
        renderReviewPage();
      }
    }

    // ========== æ•°æ®æŒä¹…åŒ– ==========
    function saveData() {
      // ä¿å­˜å½“å‰å‘¨æ•°æ®åˆ°weeklyData
      saveCurrentWeekData();
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('lifeScriptData', JSON.stringify(appState));
    }

    function loadData() {
      const saved = localStorage.getItem('lifeScriptData');
      if (saved) {
        const data = JSON.parse(saved);
        
        // åŠ è½½åŸºæœ¬ä¿¡æ¯
        appState.userName = data.userName || appState.userName;
        appState.categories = data.categories || appState.categories;
        appState.apiKey = data.apiKey || appState.apiKey;
        appState.apiProvider = data.apiProvider || appState.apiProvider;
        
        // åŠ è½½å¤šå‘¨æ•°æ®(æ–°æ ¼å¼)
        appState.weeklyData = data.weeklyData || {};
        
        // å…¼å®¹æ—§æ ¼å¼æ•°æ®
        if (data.weekPlan) appState.weekPlan = data.weekPlan;
        if (data.weekCheckin) appState.weekCheckin = data.weekCheckin;
        if (data.reviewNotes) {
          appState.reviewNotes = {
            highlight: data.reviewNotes.highlight || '',
            ng: data.reviewNotes.ng || '',
            thinking: data.reviewNotes.thinking || ''
          };
        }
      }
    }

    function exportData() {
      const dataStr = JSON.stringify(appState, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `äººç”Ÿè„šæœ¬_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          appState = data;
          saveData();
          location.reload();
        } catch (error) {
          alert('æ•°æ®å¯¼å…¥å¤±è´¥: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    // ========== å¯åŠ¨åº”ç”¨ ==========
    window.addEventListener('DOMContentLoaded', init);

    // ç»‘å®šåŸå› é€‰æ‹©å™¨çš„çº§è”æ›´æ–°
    document.addEventListener('DOMContentLoaded', () => {
      const reasonCategory = document.getElementById('reasonCategory');
      if (reasonCategory) {
        reasonCategory.addEventListener('change', updateReasonTags);
      }

      const modalCategory = document.getElementById('modalCategory');
      if (modalCategory) {
        modalCategory.addEventListener('change', updateModalTags);
      }
      
      // é¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜
      window.addEventListener('beforeunload', function(e) {
        saveData();
        console.log('ğŸ”’ é¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜');
      });
    });
  </script>
</body>
</html>
